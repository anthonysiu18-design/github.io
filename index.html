<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#07c160">
<title>é›¶é’±è®°è´¦</title>
<link rel="manifest" href="manifest.json">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

:root {
  --green: #07c160; --green-dark: #059649; --green-light: #e8f8ee;
  --red: #fa5151; --bg: #f2f2f7; --card: #fff;
  --text: #1a1a1a; --sub: #8e8e93; --border: #e5e5ea;
  --shadow: 0 1px 8px rgba(0,0,0,.06);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body {
  font-family: 'Noto Sans SC', -apple-system, sans-serif;
  background: var(--bg); color: var(--text);
  max-width: 480px; margin: 0 auto; min-height: 100vh;
  padding-bottom: 84px; overflow-x: hidden;
}

/* â”€â”€ HEADER â”€â”€ */
.header {
  background: linear-gradient(160deg, #09d366 0%, #07c160 40%, #059649 100%);
  padding: 20px 20px 32px; color: #fff; position: relative; overflow: hidden;
}
.header::before {
  content: ''; position: absolute; top: -50px; right: -50px;
  width: 160px; height: 160px; border-radius: 50%;
  background: rgba(255,255,255,.07);
}
.hd-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.hd-title { font-size: 18px; font-weight: 700; letter-spacing: .5px; }
.hd-sync {
  font-size: 12px; padding: 4px 10px; border-radius: 12px;
  background: rgba(255,255,255,.18); cursor: pointer;
  display: flex; align-items: center; gap: 5px;
}
.dot { width: 6px; height: 6px; border-radius: 50%; background: #a8f5c8; flex-shrink: 0; }
.dot.err { background: #ff8080; }
.dot.spin { background: #ffe066; animation: blink .7s infinite alternate; }
@keyframes blink { to { opacity: .2; } }

.hd-month { font-size: 13px; opacity: .8; margin-bottom: 6px; }
.hd-amount { font-size: 42px; font-weight: 300; letter-spacing: -2px; margin-bottom: 18px; }
.hd-amount em { font-size: 22px; font-style: normal; margin-right: 2px; }
.hd-row { display: flex; gap: 28px; }
.hd-stat-label { font-size: 11px; opacity: .75; margin-bottom: 3px; }
.hd-stat-val { font-size: 15px; font-weight: 500; }

/* â”€â”€ TABS â”€â”€ */
.tabs {
  background: #fff; display: flex; border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 20;
}
.tab {
  flex: 1; text-align: center; padding: 13px 0; font-size: 14px;
  color: var(--sub); cursor: pointer; position: relative; transition: color .2s;
}
.tab.active { color: var(--green); font-weight: 600; }
.tab.active::after {
  content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 28px; height: 2.5px; background: var(--green); border-radius: 2px;
}

.page { display: none; }
.page.active { display: block; }

/* â”€â”€ MONTH STRIP â”€â”€ */
.month-strip {
  display: flex; gap: 8px; padding: 14px 16px 2px;
  overflow-x: auto; scrollbar-width: none;
}
.month-strip::-webkit-scrollbar { display: none; }
.m-chip {
  flex-shrink: 0; padding: 5px 14px; border-radius: 14px; font-size: 13px;
  background: #fff; color: var(--sub); cursor: pointer;
  border: 1.5px solid var(--border); transition: all .15s; white-space: nowrap;
}
.m-chip.on { background: var(--green); color: #fff; border-color: var(--green); font-weight: 500; }

/* â”€â”€ CAT GRID â”€â”€ */
.cat-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; padding: 10px 16px; }
.cat-card {
  background: var(--card); border-radius: 14px; padding: 12px 8px; text-align: center;
  box-shadow: var(--shadow); cursor: pointer; transition: all .15s;
}
.cat-card:active { transform: scale(.95); }
.cat-card.dim { opacity: .35; }
.cat-icon { font-size: 22px; margin-bottom: 4px; }
.cat-name { font-size: 11px; color: var(--sub); margin-bottom: 3px; }
.cat-amt { font-size: 14px; font-weight: 600; }

/* â”€â”€ TX LIST â”€â”€ */
.day-label {
  padding: 10px 16px 5px; font-size: 12px; color: var(--sub);
  font-weight: 500; display: flex; justify-content: space-between; align-items: center;
}
.tx-list { padding: 0 16px 8px; }
.tx-card {
  background: var(--card); border-radius: 14px; padding: 13px 14px;
  margin-bottom: 8px; display: flex; align-items: center; box-shadow: var(--shadow);
  position: relative; overflow: hidden;
}
.tx-card::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0;
  width: 3px; background: var(--accent, #ddd); border-radius: 3px 0 0 3px;
}
.tx-ico {
  width: 42px; height: 42px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 19px; margin-right: 12px; flex-shrink: 0;
}
.tx-info { flex: 1; min-width: 0; }
.tx-name { font-size: 14px; font-weight: 500; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tx-meta { font-size: 12px; color: var(--sub); }
.tx-amt { font-size: 16px; font-weight: 700; flex-shrink: 0; margin-left: 10px; }
.tx-amt.in { color: var(--green); }

/* â”€â”€ STATS â”€â”€ */
.stat-wrap { padding: 10px 16px; }
.stat-card { background: var(--card); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); margin-bottom: 12px; }
.stat-title { font-size: 14px; font-weight: 600; margin-bottom: 14px; color: var(--text); }
.bar-row { margin-bottom: 11px; }
.bar-head { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; }
.bar-track { height: 7px; background: var(--bg); border-radius: 4px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 4px; transition: width .8s cubic-bezier(.4,0,.2,1); }
.trend { display: flex; align-items: flex-end; gap: 5px; height: 72px; padding-top: 8px; }
.t-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; height: 100%; }
.t-bar-wrap { flex: 1; width: 100%; display: flex; align-items: flex-end; }
.t-bar { width: 100%; border-radius: 4px 4px 0 0; background: var(--green); min-height: 3px; }
.t-lbl { font-size: 10px; color: var(--sub); }
.cal { display: grid; grid-template-columns: repeat(7,1fr); gap: 3px; margin-top: 4px; }
.cal-hd { text-align: center; font-size: 10px; color: var(--sub); padding: 3px 0; }
.cal-d {
  aspect-ratio: 1; border-radius: 5px; display: flex; align-items: center;
  justify-content: center; font-size: 11px; cursor: default;
}

/* â”€â”€ IMPORT â”€â”€ */
.imp-wrap { padding: 14px 16px; }
.imp-card { background: var(--card); border-radius: 16px; padding: 18px; margin-bottom: 12px; box-shadow: var(--shadow); }
.imp-card h3 { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
.imp-card p { font-size: 13px; color: var(--sub); line-height: 1.7; margin-bottom: 14px; }
.steps { margin-bottom: 14px; }
.step { display: flex; gap: 9px; margin-bottom: 9px; font-size: 13px; color: var(--sub); line-height: 1.5; align-items: flex-start; }
.step-n {
  width: 19px; height: 19px; background: var(--green); color: #fff; border-radius: 50%;
  font-size: 11px; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-top: 1px;
}
.tip-box {
  background: #f0faf5; border: 1px solid #b3e8cc; border-radius: 12px;
  padding: 12px 14px; font-size: 13px; color: #0a6b3a; line-height: 1.6; margin-bottom: 14px;
}
.tip-box strong { display: block; font-size: 13px; margin-bottom: 3px; }

/* â”€â”€ SETTINGS â”€â”€ */
.set-wrap { padding: 14px 16px; }
.set-label { font-size: 12px; color: var(--sub); letter-spacing: .5px; font-weight: 500; padding: 4px 0 9px; }
.set-card { background: var(--card); border-radius: 16px; padding: 18px; box-shadow: var(--shadow); margin-bottom: 14px; }
.set-card h3 { font-size: 15px; font-weight: 600; margin-bottom: 8px; }
.set-card p { font-size: 13px; color: var(--sub); line-height: 1.7; margin-bottom: 14px; }
.set-group { background: var(--card); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); margin-bottom: 14px; }
.set-row {
  padding: 14px 16px; display: flex; align-items: center; gap: 13px;
  border-bottom: 1px solid var(--border); cursor: pointer;
}
.set-row:last-child { border-bottom: none; }
.set-ico { font-size: 20px; }
.set-info { flex: 1; }
.set-name { font-size: 14px; font-weight: 500; }
.set-sub { font-size: 12px; color: var(--sub); margin-top: 1px; }
.set-arr { color: var(--sub); }

/* â”€â”€ FORMS â”€â”€ */
.fg { margin-bottom: 14px; }
.fl { font-size: 13px; color: var(--sub); margin-bottom: 6px; display: block; }
.fi {
  width: 100%; padding: 12px 14px; border: 1.5px solid var(--border);
  border-radius: 10px; font-size: 15px; font-family: inherit;
  outline: none; background: #fff; transition: border-color .15s;
}
.fi:focus { border-color: var(--green); }
textarea.fi { resize: vertical; }
.type-row { display: flex; background: var(--bg); border-radius: 10px; padding: 3px; margin-bottom: 14px; }
.type-btn {
  flex: 1; padding: 9px; border: none; border-radius: 8px; background: transparent;
  font-size: 14px; font-family: inherit; cursor: pointer; transition: all .15s; color: var(--sub);
}
.type-btn.on { background: #fff; box-shadow: 0 1px 5px rgba(0,0,0,.1); color: var(--green); font-weight: 600; }
.cat-pick { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; }
.cp-btn {
  padding: 10px 6px; border: 1.5px solid var(--border); border-radius: 10px;
  background: #fff; text-align: center; cursor: pointer; font-family: inherit; transition: all .15s;
}
.cp-btn.on { border-color: var(--green); background: var(--green-light); }
.cp-btn .ci { font-size: 19px; display: block; margin-bottom: 3px; }
.cp-btn .cl { font-size: 11px; color: var(--sub); }
.cp-btn.on .cl { color: var(--green-dark); }

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  display: block; width: 100%; padding: 13px; border: none; border-radius: 11px;
  font-size: 14px; font-weight: 500; cursor: pointer; font-family: inherit; transition: opacity .15s;
}
.btn:active { opacity: .8; }
.btn-g { background: var(--green); color: #fff; }
.btn-o { background: var(--green-light); color: var(--green-dark); border: 1px solid #b3e8cc; }
.btn-r { background: #fff0f0; color: var(--red); border: 1px solid #ffd6d6; }
.btn-row2 { display: flex; gap: 8px; }
.btn-row2 .btn { flex: 1; }

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bnav {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 480px; background: #fff;
  border-top: 1px solid var(--border); display: flex; z-index: 100;
  padding-bottom: env(safe-area-inset-bottom);
}
.ni { flex: 1; padding: 10px 0; text-align: center; cursor: pointer; }
.ni-ico { font-size: 22px; margin-bottom: 2px; }
.ni-lbl { font-size: 11px; color: var(--sub); }
.ni.on .ni-lbl { color: var(--green); }

/* â”€â”€ FAB â”€â”€ */
.fab {
  position: fixed; bottom: 74px; right: 20px;
  width: 54px; height: 54px; background: var(--green); color: #fff; border: none;
  border-radius: 50%; font-size: 28px; cursor: pointer;
  box-shadow: 0 4px 20px rgba(7,193,96,.45);
  display: flex; align-items: center; justify-content: center; z-index: 99;
  transition: transform .15s;
}
.fab:active { transform: scale(.91); }

/* â”€â”€ MODAL â”€â”€ */
.overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 200; align-items: flex-end; }
.overlay.open { display: flex; }
.modal {
  background: #fff; border-radius: 22px 22px 0 0; padding: 20px;
  width: 100%; max-width: 480px; margin: 0 auto;
  animation: up .25s ease; max-height: 92vh; overflow-y: auto;
}
@keyframes up { from { transform: translateY(100%); } to { transform: translateY(0); } }
.mh { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
.mt { font-size: 17px; font-weight: 700; }
.mc { font-size: 22px; color: var(--sub); cursor: pointer; line-height: 1; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed; top: 62px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,.78); color: #fff; padding: 10px 22px;
  border-radius: 22px; font-size: 14px; z-index: 999; opacity: 0;
  transition: opacity .3s; white-space: nowrap; pointer-events: none;
}
.toast.show { opacity: 1; }

.empty { text-align: center; padding: 52px 20px; color: var(--sub); }
.empty .ei { font-size: 52px; margin-bottom: 12px; }
.empty p { font-size: 14px; line-height: 1.7; }
input[type=file] { display: none; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="hd-top">
    <div class="hd-title">ğŸ’° é›¶é’±è®°è´¦</div>
    <div class="hd-sync" onclick="switchTab('settings')">
      <div class="dot" id="dot"></div>
      <span id="syncLbl">æœªé…ç½®åŒæ­¥</span>
    </div>
  </div>
  <div class="hd-month" id="hdMonth">æœ¬æœˆæ”¯å‡º</div>
  <div class="hd-amount"><em>Â¥</em><span id="hdAmt">0.00</span></div>
  <div class="hd-row">
    <div><div class="hd-stat-label">æ”¶å…¥</div><div class="hd-stat-val" id="hdIn">Â¥0.00</div></div>
    <div><div class="hd-stat-label">ç¬”æ•°</div><div class="hd-stat-val" id="hdCnt">0ç¬”</div></div>
    <div><div class="hd-stat-label">å‡€ç»“ä½™</div><div class="hd-stat-val" id="hdNet">Â¥0.00</div></div>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="go('records')">æ˜ç»†</div>
  <div class="tab" onclick="go('stats')">ç»Ÿè®¡</div>
  <div class="tab" onclick="go('import')">å¯¼å…¥</div>
  <div class="tab" onclick="go('settings')">è®¾ç½®</div>
</div>

<!-- â•â• RECORDS â•â• -->
<div class="page active" id="page-records">
  <div class="month-strip" id="mstrip"></div>
  <div class="cat-grid" id="catGrid"></div>
  <div id="txBody"></div>
</div>

<!-- â•â• STATS â•â• -->
<div class="page" id="page-stats">
  <div class="month-strip" id="mstrip2"></div>
  <div class="stat-wrap">
    <div class="stat-card">
      <div class="stat-title">ğŸ“Š åˆ†ç±»æ”¯å‡º</div>
      <div id="barChart"></div>
    </div>
    <div class="stat-card">
      <div class="stat-title">ğŸ“… è¿‘7å¤©è¶‹åŠ¿</div>
      <div class="trend" id="trend"></div>
    </div>
    <div class="stat-card">
      <div class="stat-title">ğŸ“† æœ¬æœˆçƒ­åŠ›å›¾</div>
      <div class="cal" id="cal"></div>
    </div>
  </div>
</div>

<!-- â•â• IMPORT â•â• -->
<div class="page" id="page-import">
  <div class="imp-wrap">

    <div class="tip-box">
      <strong>ğŸ’¡ æœ€æ¨èï¼šå¯¼å…¥å¾®ä¿¡å®˜æ–¹è´¦å•</strong>
      å¾®ä¿¡æ”¯æŒå¯¼å‡ºå®Œæ•´é›¶é’±æ”¶æ”¯ CSVï¼Œæ•°æ®æœ€å‡†ã€æœ€å…¨ï¼Œä¸‹æ–¹æœ‰è¯¦ç»†æ­¥éª¤ã€‚
    </div>

    <div class="imp-card">
      <h3>ğŸ“„ å¯¼å…¥å¾®ä¿¡è´¦å• CSV</h3>
      <p>å¾®ä¿¡å®˜æ–¹è´¦å•åŒ…å«å…¨éƒ¨é›¶é’±äº¤æ˜“ï¼Œæ”¯æŒè‡ªåŠ¨è¯†åˆ«åˆ†ç±»ã€‚</p>
      <div class="steps">
        <div class="step"><div class="step-n">1</div><div>å¾®ä¿¡ â†’ æˆ‘ â†’ æœåŠ¡ â†’ é’±åŒ…</div></div>
        <div class="step"><div class="step-n">2</div><div>å³ä¸Šè§’ã€Œè´¦å•ã€â†’ã€Œå¸¸è§é—®é¢˜ã€â†’ã€Œç”³è¯·è´¦å•ã€</div></div>
        <div class="step"><div class="step-n">3</div><div>é€‰æ‹©æ—¶é—´èŒƒå›´ï¼Œç­‰å¾…é‚®ä»¶ï¼ˆé€šå¸¸å‡ åˆ†é’Ÿå†…ï¼‰</div></div>
        <div class="step"><div class="step-n">4</div><div>é‚®ä»¶é™„ä»¶ä¸‹è½½ CSVï¼Œå›åˆ°æ­¤å¤„å¯¼å…¥</div></div>
      </div>
      <button class="btn btn-g" onclick="document.getElementById('csvFile').click()">ğŸ“‚ é€‰æ‹© CSV æ–‡ä»¶</button>
      <input type="file" id="csvFile" accept=".csv,.CSV" onchange="importCSV(event)">
    </div>

    <div class="imp-card">
      <h3>âœï¸ ç²˜è´´æ”¯ä»˜é€šçŸ¥</h3>
      <p>æŠŠæ‰‹æœºé€šçŸ¥æ é‡Œçš„å¾®ä¿¡æ”¯ä»˜é€šçŸ¥æ–‡å­—å¤åˆ¶ç²˜è´´è¿›æ¥ï¼Œè‡ªåŠ¨è§£æé‡‘é¢ä¸åˆ†ç±»ã€‚</p>
      <textarea class="fi" id="notifTxt" rows="3" placeholder="ä¾‹ï¼šå¾®ä¿¡æ”¯ä»˜æˆåŠŸï¼Œä»˜æ¬¾ Â¥28.50ï¼Œå•†æˆ·ï¼šç‘å¹¸å’–å•¡"></textarea>
      <br><br>
      <button class="btn btn-o" onclick="parseNotif()">ğŸ” è§£æå¹¶å¯¼å…¥</button>
    </div>

  </div>
</div>

<!-- â•â• SETTINGS â•â• -->
<div class="page" id="page-settings">
  <div class="set-wrap">

    <div class="set-label">â˜ï¸ GitHub Gist äº‘åŒæ­¥</div>
    <div class="set-card">
      <h3>å¤šè®¾å¤‡åŒæ­¥ Â· æ•°æ®å¤‡ä»½</h3>
      <p>æ•°æ®ç§å¯†å­˜å‚¨åœ¨ä½ çš„ GitHub Gistï¼Œå…è´¹æ— é™æœŸã€‚æ¢æ‰‹æœºæˆ–æ¸…é™¤æµè§ˆå™¨æ•°æ®åï¼Œå¡«å…¥åŒä¸€ Token å³å¯æ¢å¤å…¨éƒ¨è®°å½•ã€‚</p>
      <div class="steps">
        <div class="step">
          <div class="step-n">1</div>
          <div>æµè§ˆå™¨æ‰“å¼€ <strong>github.com/settings/tokens</strong>ï¼Œç‚¹ <strong>Generate new token (classic)</strong></div>
        </div>
        <div class="step">
          <div class="step-n">2</div>
          <div>Note éšæ„å¡«ï¼ŒExpiration é€‰ <strong>No expiration</strong>ï¼Œåªå‹¾é€‰ <strong>gist</strong> æƒé™</div>
        </div>
        <div class="step">
          <div class="step-n">3</div>
          <div>å¤åˆ¶ç”Ÿæˆçš„ Tokenï¼ˆ<strong>ghp_</strong> å¼€å¤´ï¼‰ï¼Œç²˜è´´åˆ°ä¸‹æ–¹</div>
        </div>
        <div class="step">
          <div class="step-n">4</div>
          <div>ç‚¹ã€Œä¿å­˜å¹¶åŒæ­¥ã€ï¼Œé¦–æ¬¡è‡ªåŠ¨åœ¨ä½ è´¦å·ä¸‹åˆ›å»ºä¸€ä¸ªç§å¯† Gist</div>
        </div>
      </div>
      <div class="fg">
        <label class="fl">GitHub Personal Access Token</label>
        <input class="fi" id="tokenIn" type="password" placeholder="ghp_xxxxxxxxxxxxxxxx" autocomplete="off">
      </div>
      <div class="fg" id="gistRow" style="display:none">
        <label class="fl">Gist IDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œå¯å¤åˆ¶åˆ°å…¶ä»–è®¾å¤‡ï¼‰</label>
        <input class="fi" id="gistIn" placeholder="é¦–æ¬¡åŒæ­¥åè‡ªåŠ¨å¡«å…¥" readonly onclick="this.select();navigator.clipboard?.writeText(this.value).then(()=>toast('Gist ID å·²å¤åˆ¶'))">
      </div>
      <div class="btn-row2">
        <button class="btn btn-g" onclick="saveAndPush()">ğŸ’¾ ä¿å­˜å¹¶åŒæ­¥</button>
        <button class="btn btn-o" onclick="pull()">â¬‡ ä»äº‘ç«¯æ¢å¤</button>
      </div>
      <div id="syncInfo" style="margin-top:10px;font-size:12px;color:var(--sub);line-height:1.6"></div>
    </div>

    <div class="set-label">ğŸ“¦ æœ¬åœ°æ•°æ®ç®¡ç†</div>
    <div class="set-group">
      <div class="set-row" onclick="exportJSON()">
        <div class="set-ico">ğŸ“¤</div>
        <div class="set-info">
          <div class="set-name">å¯¼å‡º JSON å¤‡ä»½</div>
          <div class="set-sub" id="recCnt">å…± 0 æ¡è®°å½•</div>
        </div>
        <div class="set-arr">â€º</div>
      </div>
      <div class="set-row" onclick="document.getElementById('jsonFile').click()">
        <div class="set-ico">ğŸ“¥</div>
        <div class="set-info">
          <div class="set-name">ä» JSON æ¢å¤</div>
          <div class="set-sub">åˆå¹¶å¯¼å…¥ï¼Œè‡ªåŠ¨å»é‡</div>
        </div>
        <div class="set-arr">â€º</div>
      </div>
      <div class="set-row" onclick="clearAll()">
        <div class="set-ico">ğŸ—‘ï¸</div>
        <div class="set-info">
          <div class="set-name" style="color:var(--red)">æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®</div>
          <div class="set-sub">ä¸å¯æ¢å¤ï¼Œå»ºè®®å…ˆå¯¼å‡º</div>
        </div>
        <div class="set-arr">â€º</div>
      </div>
    </div>

    <div style="text-align:center;padding:10px 0 4px;font-size:12px;color:#ccc">
      é›¶é’±è®°è´¦ Â· æ•°æ®ä»…å­˜æœ¬åœ° + ä½ çš„ GitHub Gist
    </div>
  </div>
  <input type="file" id="jsonFile" accept=".json" onchange="restoreJSON(event)" style="display:none">
</div>

<!-- FAB -->
<button class="fab" id="fab" onclick="openAdd()">+</button>

<!-- BOTTOM NAV -->
<div class="bnav">
  <div class="ni on" onclick="go('records')"><div class="ni-ico">ğŸ“‹</div><div class="ni-lbl">æ˜ç»†</div></div>
  <div class="ni" onclick="go('stats')"><div class="ni-ico">ğŸ“Š</div><div class="ni-lbl">ç»Ÿè®¡</div></div>
  <div class="ni" onclick="go('import')"><div class="ni-ico">ğŸ“¥</div><div class="ni-lbl">å¯¼å…¥</div></div>
  <div class="ni" onclick="go('settings')"><div class="ni-ico">âš™ï¸</div><div class="ni-lbl">è®¾ç½®</div></div>
</div>

<!-- ADD MODAL -->
<div class="overlay" id="addOverlay" onclick="maybeClose(event)">
  <div class="modal">
    <div class="mh"><div class="mt">æ·»åŠ è®°å½•</div><div class="mc" onclick="closeAdd()">Ã—</div></div>
    <div class="type-row">
      <button class="type-btn on" onclick="setType('out',this)">æ”¯å‡º</button>
      <button class="type-btn" onclick="setType('in',this)">æ”¶å…¥</button>
    </div>
    <div class="fg">
      <label class="fl">é‡‘é¢ï¼ˆå…ƒï¼‰</label>
      <input class="fi" id="amtIn" type="number" placeholder="0.00" step="0.01" min="0.01" inputmode="decimal">
    </div>
    <div class="fg">
      <label class="fl">æè¿°ï¼ˆè‡ªåŠ¨è¯†åˆ«åˆ†ç±»ï¼‰</label>
      <input class="fi" id="descIn" type="text" placeholder="å•†å®¶åç§° / å¤‡æ³¨â€¦">
    </div>
    <div class="fg">
      <label class="fl">åˆ†ç±»</label>
      <div class="cat-pick" id="cpick"></div>
    </div>
    <div class="fg">
      <label class="fl">æ—¶é—´</label>
      <input class="fi" id="dtIn" type="datetime-local">
    </div>
    <button class="btn btn-g" onclick="addRec()">âœ“ ä¿å­˜</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â• CATEGORIES â•â•
const CATS = [
  { id:'food',  name:'é¤é¥®',    icon:'ğŸœ', color:'#ff9500', bg:'#fff4e5' },
  { id:'life',  name:'ç”Ÿæ´»æ—¥ç”¨',icon:'ğŸ›’', color:'#34aadc', bg:'#e5f5fc' },
  { id:'trans', name:'äº¤é€š',    icon:'ğŸšŒ', color:'#5856d6', bg:'#eeeeff' },
  { id:'xfer',  name:'è½¬è´¦',    icon:'ğŸ’¸', color:'#ff5e57', bg:'#fff0ee' },
  { id:'red',   name:'çº¢åŒ…',    icon:'ğŸ§§', color:'#c0392b', bg:'#fef0ee' },
  { id:'other', name:'æ¶ˆè´¹',    icon:'ğŸ’³', color:'#8e8e93', bg:'#f2f2f7' },
];
const CM = Object.fromEntries(CATS.map(c => [c.id, c]));
const RULES = [
  { id:'food',  kw: 'é¤ é¥­ é£Ÿ èŒ¶ é¥® å’–å•¡ å¥¶èŒ¶ çƒ§çƒ¤ ç«é”… å¤–å– ç¾å›¢ é¥¿äº†ä¹ˆ éº¦å½“åŠ³ è‚¯å¾·åŸº æ˜Ÿå·´å…‹ ç‘å¹¸ èœœé›ª èŒ¶ç™¾é“ æµ·åº•æ å°åƒ é¢é¦† ç²¥ å¯¿å¸ æŠ«è¨ å ‚é£Ÿ æ—©é¤ åˆé¤ æ™šé¤ å®µå¤œ é¢åŒ… è›‹ç³• å¿«é¤ ç‚¸é¸¡ æ±‰å ¡ ç”œå“ å†°æ·‡æ·‹ æœæ±'.split(' ') },
  { id:'life',  kw: 'è¶…å¸‚ ä¾¿åˆ©åº— è¯åº— è¯æˆ¿ ç†å‘ å‘å»Š ç¾å®¹ ç¾ç”² æ´—è¡£ æ°´ç”µ ç‰©ä¸š è´­ç‰© è¡£æœ æœè£… é‹ æ—¥ç”¨ ç”Ÿæ´» æ²ƒå°”ç› æ°¸è¾‰ ç›’é©¬ äº¬ä¸œ æ·˜å® æ‹¼å¤šå¤š å®å’š 711 å…¨å®¶ ç½—æ£® å®¶ä¹ç¦ è¯è´¹ å®½å¸¦ æµé‡'.split(' ') },
  { id:'trans', kw: 'åœ°é“ å…¬äº¤ æ‰“è½¦ æ»´æ»´ å‡ºç§Ÿ é«˜é“ ç«è½¦ é£æœº æœºç¥¨ èˆªç©º åŠ æ²¹ åœè½¦ å•è½¦ æ‘©æ‹œ å“ˆå•° é«˜é€Ÿ ETC äº¤é€š'.split(' ') },
  { id:'xfer',  kw: 'è½¬è´¦ è½¬ç»™ æ±‡æ¬¾ è¿˜æ¬¾ å€Ÿæ¬¾ è¿˜ä½ '.split(' ') },
  { id:'red',   kw: 'çº¢åŒ…'.split(' ') },
];
function guess(t = '') {
  for (const r of RULES) if (r.kw.some(k => t.includes(k))) return r.id;
  return 'other';
}

// â•â• STATE â•â•
let recs = JSON.parse(localStorage.getItem('zlrec') || '[]');
let cfg  = JSON.parse(localStorage.getItem('zlcfg') || '{}');
let curM = new Date().toISOString().slice(0, 7);
let txT  = 'out';
let selC = 'other';
let filtC = null;
let syncTimer = null;

const save = () => { localStorage.setItem('zlrec', JSON.stringify(recs)); schedSync(); };
const saveCfg = () => localStorage.setItem('zlcfg', JSON.stringify(cfg));

// â•â• MONTHS â•â•
function getMonths() {
  const s = new Set(recs.map(r => r.date.slice(0, 7)));
  s.add(new Date().toISOString().slice(0, 7));
  return [...s].sort().reverse().slice(0, 6);
}
function mLabel(m) {
  const [y, mo] = m.split('-');
  const cur = new Date().getFullYear().toString();
  return y === cur ? `${+mo}æœˆ` : `${y}/${+mo}æœˆ`;
}
function renderStrips() {
  const html = getMonths().map(m =>
    `<div class="m-chip ${m === curM ? 'on' : ''}" onclick="setM('${m}')">${mLabel(m)}</div>`
  ).join('');
  document.getElementById('mstrip').innerHTML = html;
  document.getElementById('mstrip2').innerHTML = html;
}
function setM(m) { curM = m; filtC = null; render(); }

// â•â• MAIN RENDER â•â•
function render() {
  renderStrips();
  const all = recs.filter(r => r.date.startsWith(curM));
  const out = all.filter(r => r.type === 'out');
  const inn = all.filter(r => r.type === 'in');
  const tO = out.reduce((s, r) => s + r.amount, 0);
  const tI = inn.reduce((s, r) => s + r.amount, 0);

  // Header
  const [y, mo] = curM.split('-');
  const isThis = curM === new Date().toISOString().slice(0, 7);
  document.getElementById('hdMonth').textContent = isThis ? 'æœ¬æœˆæ”¯å‡º' : `${y}å¹´${+mo}æœˆæ”¯å‡º`;
  document.getElementById('hdAmt').textContent = tO.toFixed(2);
  document.getElementById('hdIn').textContent = 'Â¥' + tI.toFixed(2);
  document.getElementById('hdCnt').textContent = all.length + 'ç¬”';
  document.getElementById('hdNet').textContent = 'Â¥' + (tI - tO).toFixed(2);
  document.getElementById('recCnt').textContent = `å…± ${recs.length} æ¡è®°å½•`;

  renderGrid(out);
  const disp = filtC ? all.filter(r => r.cat === filtC) : all;
  renderList(disp);
  renderStats(all);
  renderSyncStatus();
}

// â”€â”€ Grid â”€â”€
function renderGrid(out) {
  const t = {}; CATS.forEach(c => t[c.id] = 0);
  out.forEach(r => t[r.cat] = (t[r.cat] || 0) + r.amount);
  document.getElementById('catGrid').innerHTML = CATS.map(c =>
    `<div class="cat-card ${filtC && filtC !== c.id ? 'dim' : ''}" onclick="filt('${c.id}')">
      <div class="cat-icon">${c.icon}</div>
      <div class="cat-name">${c.name}</div>
      <div class="cat-amt" style="color:${c.color}">Â¥${t[c.id].toFixed(0)}</div>
    </div>`
  ).join('');
}
function filt(id) {
  filtC = filtC === id ? null : id;
  const all = recs.filter(r => r.date.startsWith(curM));
  renderGrid(all.filter(r => r.type === 'out'));
  renderList(filtC ? all.filter(r => r.cat === filtC) : all);
}

// â”€â”€ List â”€â”€
function renderList(data) {
  const body = document.getElementById('txBody');
  if (!data.length) {
    body.innerHTML = `<div class="empty"><div class="ei">ğŸ“‹</div><p>æš‚æ— è®°å½•<br>å³ä¸‹è§’ <strong>+</strong> æ‰‹åŠ¨æ·»åŠ <br>æˆ–åœ¨ã€Œå¯¼å…¥ã€é¡µå¯¼å…¥å¾®ä¿¡è´¦å•</p></div>`;
    return;
  }
  const sorted = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));
  const todayStr = new Date().toISOString().slice(0, 10);
  const yestStr = (() => { const d = new Date(); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); })();
  let html = '';
  let lastDay = '';
  sorted.forEach(r => {
    const day = r.date.slice(0, 10);
    if (day !== lastDay) {
      const dayLbl = day === todayStr ? 'ä»Šå¤©' : day === yestStr ? 'æ˜¨å¤©' : day.slice(5).replace('-', '/');
      const dayOut = sorted.filter(x=>x.date.slice(0,10)===day&&x.type==='out').reduce((s,x)=>s+x.amount,0);
      html += `<div class="day-label"><span>${dayLbl}</span><span style="color:var(--sub);font-size:11px">æ”¯å‡º Â¥${dayOut.toFixed(2)}</span></div>`;
      lastDay = day;
    }
    const c = CM[r.cat] || CM.other;
    const d = new Date(r.date);
    const tm = `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
    const idx = recs.findIndex(x => x === r);
    html += `
      <div class="tx-list">
        <div class="tx-card" style="--accent:${c.color}" onclick="delRec(${idx})">
          <div class="tx-ico" style="background:${c.bg}">${c.icon}</div>
          <div class="tx-info">
            <div class="tx-name">${r.desc || c.name}</div>
            <div class="tx-meta">${tm} Â· ${c.name}</div>
          </div>
          <div class="tx-amt ${r.type}">${r.type==='in'?'+':'-'}Â¥${r.amount.toFixed(2)}</div>
        </div>
      </div>`;
  });
  body.innerHTML = html;
}

// â”€â”€ Stats â”€â”€
function renderStats(all) {
  const out = all.filter(r => r.type === 'out');
  const t = {}; CATS.forEach(c => t[c.id] = 0);
  out.forEach(r => t[r.cat] = (t[r.cat] || 0) + r.amount);
  const total = out.reduce((s, r) => s + r.amount, 0) || 1;

  document.getElementById('barChart').innerHTML = CATS.map(c => {
    const pct = ((t[c.id] / total) * 100).toFixed(1);
    return `<div class="bar-row">
      <div class="bar-head">
        <span>${c.icon} ${c.name}</span>
        <span style="color:${c.color}">Â¥${t[c.id].toFixed(2)} <small style="color:var(--sub)">${pct}%</small></span>
      </div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${c.color}"></div></div>
    </div>`;
  }).join('');

  // 7-day
  const tr = {};
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    tr[d.toISOString().slice(0, 10)] = 0;
  }
  out.forEach(r => { const k = r.date.slice(0, 10); if (k in tr) tr[k] += r.amount; });
  const mx = Math.max(...Object.values(tr)) || 1;
  document.getElementById('trend').innerHTML = Object.entries(tr).map(([d, v]) =>
    `<div class="t-col">
      <div class="t-bar-wrap"><div class="t-bar" style="height:${Math.max(3,(v/mx)*100)}%"></div></div>
      <div class="t-lbl">${d.slice(8)}</div>
    </div>`
  ).join('');

  // Calendar
  const [y, mo] = curM.split('-').map(Number);
  const dim = new Date(y, mo, 0).getDate();
  const fd = new Date(y, mo - 1, 1).getDay();
  const dt = {}; out.filter(r => r.date.startsWith(curM)).forEach(r => {
    const d = +r.date.slice(8, 10); dt[d] = (dt[d] || 0) + r.amount;
  });
  const mdv = Math.max(...Object.values(dt)) || 1;
  const today = new Date().getDate();
  const isThisM = curM === new Date().toISOString().slice(0, 7);
  let ch = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(h => `<div class="cal-hd">${h}</div>`).join('');
  for (let i = 0; i < fd; i++) ch += '<div></div>';
  for (let d = 1; d <= dim; d++) {
    const v = dt[d] || 0;
    const op = v ? Math.max(0.12, v / mdv) : 0;
    const isToday = isThisM && d === today;
    ch += `<div class="cal-d" title="${d}æ—¥ Â¥${v.toFixed(0)}"
      style="background:${v ? `rgba(7,193,96,${op})` : '#f2f2f7'};
             ${isToday ? 'outline:2px solid var(--green);' : ''}
             color:${v > mdv * .6 ? '#fff' : 'var(--sub)'}">
      ${d}
    </div>`;
  }
  document.getElementById('cal').innerHTML = ch;
}

// â•â• TABS â•â•
const PAGES = ['records','stats','import','settings'];
function go(p) {
  PAGES.forEach(id => {
    document.getElementById('page-' + id).classList.toggle('active', id === p);
  });
  document.querySelectorAll('.tab').forEach((el, i) => el.classList.toggle('active', PAGES[i] === p));
  document.querySelectorAll('.ni').forEach((el, i) => el.classList.toggle('on', PAGES[i] === p));
  document.getElementById('fab').style.display = (p === 'records' || p === 'import') ? 'flex' : 'none';
  render();
}

// â•â• ADD RECORD â•â•
function openAdd() {
  document.getElementById('addOverlay').classList.add('open');
  const n = new Date(); n.setMinutes(n.getMinutes() - n.getTimezoneOffset());
  document.getElementById('dtIn').value = n.toISOString().slice(0, 16);
  selC = 'other'; renderCatPick();
}
function closeAdd() { document.getElementById('addOverlay').classList.remove('open'); }
function maybeClose(e) { if (e.target === document.getElementById('addOverlay')) closeAdd(); }
function setType(t, btn) {
  txT = t;
  document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
}
function renderCatPick() {
  document.getElementById('cpick').innerHTML = CATS.map(c =>
    `<button class="cp-btn ${selC === c.id ? 'on' : ''}" onclick="pickC('${c.id}',this)">
      <span class="ci">${c.icon}</span><span class="cl">${c.name}</span>
    </button>`
  ).join('');
}
function pickC(id, btn) {
  selC = id;
  document.querySelectorAll('.cp-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
}
document.getElementById('descIn').addEventListener('input', function() {
  selC = guess(this.value); renderCatPick();
});
function addRec() {
  const amt = parseFloat(document.getElementById('amtIn').value);
  const desc = document.getElementById('descIn').value.trim();
  const date = document.getElementById('dtIn').value;
  if (!amt || amt <= 0) { toast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢'); return; }
  if (!date) { toast('è¯·é€‰æ‹©æ—¶é—´'); return; }
  const cat = selC === 'other' ? guess(desc) : selC;
  recs.push({ id: Date.now() + '', amount: amt, desc, cat, type: txT, date });
  save(); closeAdd(); render();
  document.getElementById('amtIn').value = '';
  document.getElementById('descIn').value = '';
  toast((txT === 'in' ? 'æ”¶å…¥ +' : 'æ”¯å‡º -') + 'Â¥' + amt.toFixed(2) + ' å·²è®°å½•');
}
function delRec(i) {
  if (i < 0) return;
  const r = recs[i];
  if (confirm(`åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ\n${r.desc || 'æ— æè¿°'}  Â¥${r.amount.toFixed(2)}`)) {
    recs.splice(i, 1); save(); render(); toast('å·²åˆ é™¤');
  }
}

// â•â• CSV IMPORT â•â•
function importCSV(e) {
  const f = e.target.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const parsed = parseWxCSV(ev.target.result);
      if (!parsed.length) { toast('æœªæ‰¾åˆ°æœ‰æ•ˆè®°å½•ï¼Œæ£€æŸ¥æ–‡ä»¶æ ¼å¼'); return; }
      const ex = new Set(recs.map(r => `${r.date.slice(0,16)}|${r.amount}`));
      const nw = parsed.filter(r => !ex.has(`${r.date.slice(0,16)}|${r.amount}`));
      recs.push(...nw); save(); render();
      toast(`å¯¼å…¥ ${nw.length} æ¡ï¼Œè·³è¿‡ ${parsed.length - nw.length} æ¡é‡å¤`);
    } catch (err) { toast('è§£æå¤±è´¥ï¼š' + err.message); }
  };
  reader.readAsText(f, 'UTF-8'); e.target.value = '';
}

function parseWxCSV(raw) {
  const text = raw.replace(/^\uFEFF/, '');
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
  let hi = -1;
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].includes('äº¤æ˜“æ—¶é—´') && lines[i].includes('é‡‘é¢')) { hi = i; break; }
  }
  if (hi < 0) throw new Error('æ‰¾ä¸åˆ°è¡¨å¤´ï¼ˆéœ€åŒ…å«"äº¤æ˜“æ—¶é—´"å’Œ"é‡‘é¢"ï¼‰');

  function pr(line) {
    const cs = []; let cur = '', q = false;
    for (const ch of line) {
      if (ch === '"') q = !q;
      else if (ch === ',' && !q) { cs.push(cur.trim()); cur = ''; }
      else cur += ch;
    }
    cs.push(cur.trim()); return cs;
  }

  const hds = pr(lines[hi]);
  const gi = n => hds.findIndex(h => h.includes(n));
  const cD = gi('äº¤æ˜“æ—¶é—´'), cT = gi('æ”¶/æ”¯'), cA = gi('é‡‘é¢');
  const cP = gi('äº¤æ˜“å¯¹æ–¹'), cG = gi('å•†å“'), cS = gi('å½“å‰çŠ¶æ€');

  const res = [];
  for (let i = hi + 1; i < lines.length; i++) {
    const cs = pr(lines[i]); if (cs.length < 4) continue;
    if (cS >= 0 && (cs[cS]||'').includes('é€€æ¬¾')) continue;
    const amt = parseFloat((cs[cA] || '').replace(/[Â¥,\s]/g, ''));
    if (isNaN(amt) || amt <= 0) continue;
    const type = (cs[cT] || '').includes('æ”¶å…¥') ? 'in' : 'out';
    const peer = cs[cP] || '', goods = cs[cG] || '';
    const desc = [peer, goods].filter(x => x && x !== '/' && x !== 'æ— ').join(' ').trim();
    res.push({ id: Date.now() + Math.random() + '', amount: amt, desc, cat: guess(desc), type, date: (cs[cD] || '').replace(/\//g, '-') });
  }
  return res;
}

// â•â• NOTIF PARSE â•â•
function parseNotif() {
  const t = document.getElementById('notifTxt').value.trim();
  if (!t) { toast('è¯·ç²˜è´´é€šçŸ¥æ–‡æœ¬'); return; }
  const m = t.match(/[Â¥ï¿¥](\d+\.?\d*)/);
  if (!m) { toast('æœªè¯†åˆ«åˆ°é‡‘é¢'); return; }
  const amt = parseFloat(m[1]);
  const type = (t.includes('æ”¶æ¬¾') || t.includes('æ”¶åˆ°')) && !t.includes('ä½ å·²æ”¯ä»˜') ? 'in' : 'out';
  const cat = t.includes('çº¢åŒ…') ? 'red' : t.includes('è½¬è´¦') ? 'xfer' : guess(t);
  recs.push({ id: Date.now() + '', amount: amt, desc: t.slice(0, 40), cat, type, date: new Date().toISOString() });
  save(); render(); document.getElementById('notifTxt').value = '';
  toast((type === 'in' ? 'æ”¶å…¥ +' : 'æ”¯å‡º -') + 'Â¥' + amt.toFixed(2) + ' å·²å¯¼å…¥');
}

// â•â• GIST SYNC â•â•
function schedSync() {
  if (!cfg.token) return;
  clearTimeout(syncTimer);
  syncTimer = setTimeout(pushGist, 5000);
}

function renderSyncStatus() {
  const dot = document.getElementById('dot');
  const lbl = document.getElementById('syncLbl');
  const info = document.getElementById('syncInfo');
  if (cfg.token) {
    document.getElementById('tokenIn').value = cfg.token;
    if (cfg.gistId) {
      document.getElementById('gistIn').value = cfg.gistId;
      document.getElementById('gistRow').style.display = 'block';
    }
    const last = cfg.lastSync
      ? new Date(cfg.lastSync).toLocaleString('zh-CN', { month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit' })
      : 'ä»æœª';
    dot.className = 'dot';
    lbl.textContent = 'å·²åŒæ­¥ ' + last;
    info.textContent = cfg.gistId ? 'ğŸ“ Gist ID: ' + cfg.gistId + '\næ¯æ¬¡è®°å½•æ›´æ”¹åçº¦5ç§’è‡ªåŠ¨ä¸Šä¼ ' : '';
  } else {
    dot.className = 'dot err';
    lbl.textContent = 'æœªé…ç½®åŒæ­¥';
    info.textContent = '';
  }
}

async function saveAndPush() {
  const tok = document.getElementById('tokenIn').value.trim();
  const gid = document.getElementById('gistIn').value.trim();
  if (!tok || !(tok.startsWith('ghp_') || tok.startsWith('github_pat_'))) {
    toast('Token æ ¼å¼ä¸å¯¹ï¼Œéœ€ä»¥ ghp_ å¼€å¤´'); return;
  }
  cfg.token = tok; if (gid) cfg.gistId = gid; saveCfg();
  await pushGist();
}

async function pushGist() {
  if (!cfg.token) return;
  const dot = document.getElementById('dot'), lbl = document.getElementById('syncLbl');
  dot.className = 'dot spin'; lbl.textContent = 'åŒæ­¥ä¸­â€¦';
  const body = {
    description: 'é›¶é’±è®°è´¦æ•°æ®ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰', public: false,
    files: { 'wl_records.json': { content: JSON.stringify({ records: recs, updatedAt: new Date().toISOString() }) } }
  };
  try {
    const url = 'https://api.github.com/gists' + (cfg.gistId ? '/' + cfg.gistId : '');
    const res = await fetch(url, {
      method: cfg.gistId ? 'PATCH' : 'POST',
      headers: { Authorization: 'token ' + cfg.token, 'Content-Type': 'application/json', 'X-GitHub-Api-Version': '2022-11-28' },
      body: JSON.stringify(body)
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.message || res.status); }
    const data = await res.json();
    cfg.gistId = data.id; cfg.lastSync = new Date().toISOString(); saveCfg();
    document.getElementById('gistIn').value = data.id;
    document.getElementById('gistRow').style.display = 'block';
    renderSyncStatus(); toast('â˜ åŒæ­¥æˆåŠŸ');
  } catch (e) {
    dot.className = 'dot err'; lbl.textContent = 'åŒæ­¥å¤±è´¥';
    toast('åŒæ­¥å¤±è´¥ï¼š' + e.message);
  }
}

async function pull() {
  if (!cfg.token || !cfg.gistId) { toast('è¯·å…ˆä¿å­˜ Token å¹¶å®Œæˆä¸€æ¬¡åŒæ­¥'); return; }
  try {
    const res = await fetch('https://api.github.com/gists/' + cfg.gistId, {
      headers: { Authorization: 'token ' + cfg.token }
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    const raw = data.files['wl_records.json']?.content;
    if (!raw) throw new Error('Gist ä¸­æš‚æ— æ•°æ®');
    const { records: remote } = JSON.parse(raw);
    const ex = new Set(recs.map(r => r.id));
    const nw = remote.filter(r => !ex.has(r.id));
    recs.push(...nw); save(); render();
    toast(nw.length ? `å·²æ¢å¤ ${nw.length} æ¡è®°å½•` : 'æœ¬åœ°å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ¢å¤');
  } catch (e) { toast('æ¢å¤å¤±è´¥ï¼š' + e.message); }
}

// â•â• DATA â•â•
function exportJSON() {
  const blob = new Blob([JSON.stringify({ records: recs, exportedAt: new Date().toISOString() }, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'é›¶é’±è®°è´¦_' + new Date().toISOString().slice(0, 10) + '.json'; a.click();
}
function restoreJSON(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    try {
      const d = JSON.parse(ev.target.result);
      const imp = d.records || d;
      if (!Array.isArray(imp)) throw 0;
      const ex = new Set(recs.map(x => x.id || `${x.date}|${x.amount}`));
      const nw = imp.filter(x => !ex.has(x.id || `${x.date}|${x.amount}`));
      recs.push(...nw); save(); render(); toast('å·²æ¢å¤ ' + nw.length + ' æ¡');
    } catch { toast('æ–‡ä»¶æ ¼å¼é”™è¯¯'); }
  };
  r.readAsText(f); e.target.value = '';
}
function clearAll() {
  if (!confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼Ÿ\nå»ºè®®å…ˆç‚¹ã€Œå¯¼å‡º JSON å¤‡ä»½ã€ï¼Œæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) return;
  recs = []; save(); render(); toast('æœ¬åœ°æ•°æ®å·²æ¸…é™¤');
}

// â•â• TOAST â•â•
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2600);
}

// â•â• DEMO DATA â•â•
if (!recs.length) {
  const now = new Date();
  const d = (daysAgo, h = 12, m = 0) => {
    const x = new Date(now); x.setDate(x.getDate() - daysAgo); x.setHours(h, m, 0); return x.toISOString();
  };
  recs = [
    { id:'d1', amount:28.5,  desc:'ç‘å¹¸å’–å•¡',      cat:'food',  type:'out', date:d(0,9,30) },
    { id:'d2', amount:56,    desc:'ç¾å›¢å¤–å–Â·éº¦å½“åŠ³', cat:'food',  type:'out', date:d(0,12,10) },
    { id:'d3', amount:4.2,   desc:'åœ°é“å‡ºè¡Œ',       cat:'trans', type:'out', date:d(1,8,5) },
    { id:'d4', amount:200,   desc:'è½¬è´¦ç»™å¦ˆå¦ˆ',     cat:'xfer',  type:'out', date:d(1,19,0) },
    { id:'d5', amount:88,    desc:'å‘çº¢åŒ…',         cat:'red',   type:'out', date:d(2,20,0) },
    { id:'d6', amount:300,   desc:'æ”¶çº¢åŒ…',         cat:'red',   type:'in',  date:d(3,9,0) },
    { id:'d7', amount:45.8,  desc:'å…¨å®¶ä¾¿åˆ©åº—',     cat:'life',  type:'out', date:d(3,18,20) },
    { id:'d8', amount:12,    desc:'æ»´æ»´å¿«è½¦',       cat:'trans', type:'out', date:d(4,21,30) },
    { id:'d9', amount:138,   desc:'æ·˜å®Â·æ—¥ç”¨å“',    cat:'life',  type:'out', date:d(5,14,0) },
    { id:'d10',amount:32,    desc:'èŒ¶ç™¾é“å¥¶èŒ¶',     cat:'food',  type:'out', date:d(5,16,0) },
  ];
  localStorage.setItem('zlrec', JSON.stringify(recs));
}

render();
</script>
</body>
</html>
