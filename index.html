<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#07c160">
<title>é›¶é’±è®°è´¦</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
:root{--g:#07c160;--gd:#059649;--gl:#e8f8ee;--r:#fa5151;--bg:#f2f2f7;--card:#fff;--tx:#1a1a1a;--sub:#8e8e93;--bd:#e5e5ea;--sh:0 1px 8px rgba(0,0,0,.07)}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans SC',-apple-system,sans-serif;background:var(--bg);color:var(--tx);max-width:480px;margin:0 auto;min-height:100vh;padding-bottom:84px;overflow-x:hidden}

/* AUTH SCREEN */
#authScreen{position:fixed;inset:0;background:linear-gradient(160deg,#09d366,#07c160 40%,#059649);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;padding:32px}
#authScreen.hidden{display:none}
.auth-logo{font-size:64px;margin-bottom:16px}
.auth-title{font-size:26px;font-weight:700;color:#fff;margin-bottom:6px;letter-spacing:.5px}
.auth-sub{font-size:14px;color:rgba(255,255,255,.8);margin-bottom:40px}
.auth-card{background:#fff;border-radius:20px;padding:24px;width:100%;max-width:360px;box-shadow:0 8px 40px rgba(0,0,0,.15)}
.auth-tabs{display:flex;background:var(--bg);border-radius:10px;padding:3px;margin-bottom:20px}
.auth-tab{flex:1;padding:9px;border:none;border-radius:8px;background:transparent;font-size:14px;font-family:inherit;cursor:pointer;color:var(--sub);transition:all .15s}
.auth-tab.on{background:#fff;color:var(--g);font-weight:600;box-shadow:0 1px 5px rgba(0,0,0,.1)}
.auth-inp{width:100%;padding:12px 14px;border:1.5px solid var(--bd);border-radius:10px;font-size:15px;font-family:inherit;outline:none;margin-bottom:12px;transition:border-color .15s}
.auth-inp:focus{border-color:var(--g)}
.auth-btn{width:100%;padding:14px;border:none;border-radius:11px;background:var(--g);color:#fff;font-size:15px;font-weight:600;font-family:inherit;cursor:pointer;margin-top:4px;transition:opacity .15s}
.auth-btn:active{opacity:.85}
.auth-err{font-size:13px;color:var(--r);text-align:center;margin-top:10px;min-height:18px}
.auth-footer{font-size:12px;color:rgba(255,255,255,.7);margin-top:20px;text-align:center;line-height:1.6}

/* SETUP SCREEN */
#setupScreen{position:fixed;inset:0;background:var(--bg);z-index:900;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px}
#setupScreen.hidden{display:none}
.setup-card{background:#fff;border-radius:20px;padding:28px;width:100%;max-width:400px;box-shadow:var(--sh)}
.setup-card h2{font-size:18px;font-weight:700;margin-bottom:8px}
.setup-card p{font-size:13px;color:var(--sub);line-height:1.7;margin-bottom:20px}
.setup-link{color:var(--g);text-decoration:none;font-weight:500}

/* HEADER */
.hdr{background:linear-gradient(160deg,#09d366,#07c160 40%,#059649);padding:18px 20px 28px;color:#fff;position:relative;overflow:hidden}
.hdr::before{content:'';position:absolute;top:-50px;right:-50px;width:160px;height:160px;border-radius:50%;background:rgba(255,255,255,.07)}
.hdr-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.hdr-title{font-size:17px;font-weight:700}
.hdr-user{font-size:12px;background:rgba(255,255,255,.18);padding:4px 10px;border-radius:12px;cursor:pointer;display:flex;align-items:center;gap:6px}
.hdr-month{font-size:12px;opacity:.8;margin-bottom:5px}
.hdr-amt{font-size:40px;font-weight:300;letter-spacing:-2px;margin-bottom:16px}
.hdr-amt em{font-size:21px;font-style:normal;margin-right:2px}
.hdr-row{display:flex;gap:26px}
.sl{font-size:11px;opacity:.75;margin-bottom:3px}
.sv{font-size:15px;font-weight:500}

/* TABS */
.tabs{background:#fff;display:flex;border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:20}
.tab{flex:1;text-align:center;padding:13px 0;font-size:13px;color:var(--sub);cursor:pointer;position:relative;transition:color .2s}
.tab.on{color:var(--g);font-weight:600}
.tab.on::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:26px;height:2.5px;background:var(--g);border-radius:2px}
.page{display:none}.page.on{display:block}

/* MONTH STRIP */
.ms{display:flex;gap:8px;padding:12px 16px 0;overflow-x:auto;scrollbar-width:none}
.ms::-webkit-scrollbar{display:none}
.mc{flex-shrink:0;padding:5px 14px;border-radius:14px;font-size:13px;background:#fff;color:var(--sub);cursor:pointer;border:1.5px solid var(--bd);white-space:nowrap}
.mc.on{background:var(--g);color:#fff;border-color:var(--g);font-weight:500}

/* CAT GRID */
.cg{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:10px 16px}
.cc{background:var(--card);border-radius:14px;padding:12px 8px;text-align:center;box-shadow:var(--sh);cursor:pointer;transition:all .15s}
.cc:active{transform:scale(.95)}
.cc.dim{opacity:.3}
.ci{font-size:22px;margin-bottom:4px}
.cn{font-size:11px;color:var(--sub);margin-bottom:3px}
.ca{font-size:14px;font-weight:600}

/* TX LIST */
.dl{padding:10px 16px 5px;font-size:12px;color:var(--sub);font-weight:500;display:flex;justify-content:space-between}
.tl{padding:0 16px 8px}
.tc{background:var(--card);border-radius:14px;padding:13px 14px;margin-bottom:8px;display:flex;align-items:center;box-shadow:var(--sh);position:relative;overflow:hidden}
.tc::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--ac,#ddd);border-radius:3px 0 0 3px}
.tci{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:19px;margin-right:12px;flex-shrink:0}
.tin{flex:1;min-width:0}
.tn{font-size:14px;font-weight:500;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tm{font-size:12px;color:var(--sub)}
.ta{font-size:16px;font-weight:700;flex-shrink:0;margin-left:10px}
.ta.in{color:var(--g)}

/* STATS */
.sw{padding:10px 16px}
.sc{background:var(--card);border-radius:16px;padding:16px;box-shadow:var(--sh);margin-bottom:12px}
.st{font-size:14px;font-weight:600;margin-bottom:14px}
.br{margin-bottom:11px}
.bh{display:flex;justify-content:space-between;font-size:13px;margin-bottom:5px}
.bt{height:7px;background:var(--bg);border-radius:4px;overflow:hidden}
.bf{height:100%;border-radius:4px;transition:width .8s cubic-bezier(.4,0,.2,1)}
.trnd{display:flex;align-items:flex-end;gap:5px;height:72px;padding-top:8px}
.tc2{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;height:100%}
.tbw{flex:1;width:100%;display:flex;align-items:flex-end}
.tb{width:100%;border-radius:4px 4px 0 0;background:var(--g);min-height:3px}
.tl2{font-size:10px;color:var(--sub)}
.cal{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:4px}
.chd{text-align:center;font-size:10px;color:var(--sub);padding:3px 0}
.cd{aspect-ratio:1;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:11px}

/* IMPORT */
.iw{padding:14px 16px}
.ic{background:var(--card);border-radius:16px;padding:18px;margin-bottom:12px;box-shadow:var(--sh)}
.ic h3{font-size:15px;font-weight:600;margin-bottom:6px}
.ic p{font-size:13px;color:var(--sub);line-height:1.7;margin-bottom:14px}
.steps{margin-bottom:14px}
.step{display:flex;gap:9px;margin-bottom:9px;font-size:13px;color:var(--sub);line-height:1.5;align-items:flex-start}
.sn{width:19px;height:19px;background:var(--g);color:#fff;border-radius:50%;font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.tip{background:#f0faf5;border:1px solid #b3e8cc;border-radius:12px;padding:12px 14px;font-size:13px;color:#0a6b3a;line-height:1.6;margin-bottom:14px}
.tip strong{display:block;margin-bottom:3px}
.webhook-box{background:#1e1e2e;border-radius:10px;padding:12px 14px;font-size:12px;font-family:monospace;color:#a6e3a1;word-break:break-all;margin-bottom:12px;line-height:1.6;cursor:pointer}

/* SETTINGS */
.setw{padding:14px 16px}
.setl{font-size:12px;color:var(--sub);letter-spacing:.5px;font-weight:500;padding:4px 0 9px}
.setc{background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--sh);margin-bottom:14px}
.setc h3{font-size:15px;font-weight:600;margin-bottom:8px}
.setg{background:var(--card);border-radius:16px;overflow:hidden;box-shadow:var(--sh);margin-bottom:14px}
.setr{padding:14px 16px;display:flex;align-items:center;gap:13px;border-bottom:1px solid var(--bd);cursor:pointer}
.setr:last-child{border-bottom:none}
.setico{font-size:20px}
.setinfo{flex:1}
.setname{font-size:14px;font-weight:500}
.setsub{font-size:12px;color:var(--sub);margin-top:1px}

/* FORMS */
.fg{margin-bottom:14px}
.fl{font-size:13px;color:var(--sub);margin-bottom:6px;display:block}
.fi{width:100%;padding:12px 14px;border:1.5px solid var(--bd);border-radius:10px;font-size:15px;font-family:inherit;outline:none;background:#fff;transition:border-color .15s}
.fi:focus{border-color:var(--g)}
textarea.fi{resize:vertical}
.tyr{display:flex;background:var(--bg);border-radius:10px;padding:3px;margin-bottom:14px}
.tyb{flex:1;padding:9px;border:none;border-radius:8px;background:transparent;font-size:14px;font-family:inherit;cursor:pointer;transition:all .15s;color:var(--sub)}
.tyb.on{background:#fff;box-shadow:0 1px 5px rgba(0,0,0,.1);color:var(--g);font-weight:600}
.cp{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.cpb{padding:10px 6px;border:1.5px solid var(--bd);border-radius:10px;background:#fff;text-align:center;cursor:pointer;font-family:inherit;transition:all .15s}
.cpb.on{border-color:var(--g);background:var(--gl)}
.cpb .cpi{font-size:19px;display:block;margin-bottom:3px}
.cpb .cpl{font-size:11px;color:var(--sub)}
.cpb.on .cpl{color:var(--gd)}

/* BUTTONS */
.btn{display:block;width:100%;padding:13px;border:none;border-radius:11px;font-size:14px;font-weight:500;cursor:pointer;font-family:inherit;transition:opacity .15s}
.btn:active{opacity:.8}
.bg{background:var(--g);color:#fff}
.bo{background:var(--gl);color:var(--gd);border:1px solid #b3e8cc}
.br2{background:#fff0f0;color:var(--r);border:1px solid #ffd6d6}
.brow{display:flex;gap:8px}
.brow .btn{flex:1}

/* FAB / NAV */
.bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:#fff;border-top:1px solid var(--bd);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
.ni{flex:1;padding:10px 0;text-align:center;cursor:pointer}
.nico{font-size:22px;margin-bottom:2px}
.nlbl{font-size:11px;color:var(--sub)}
.ni.on .nlbl{color:var(--g)}
.fab{position:fixed;bottom:74px;right:20px;width:54px;height:54px;background:var(--g);color:#fff;border:none;border-radius:50%;font-size:28px;cursor:pointer;box-shadow:0 4px 20px rgba(7,193,96,.45);display:flex;align-items:center;justify-content:center;z-index:99;transition:transform .15s}
.fab:active{transform:scale(.91)}

/* MODAL */
.ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:flex-end}
.ov.open{display:flex}
.modal{background:#fff;border-radius:22px 22px 0 0;padding:20px;width:100%;max-width:480px;margin:0 auto;animation:up .25s ease;max-height:92vh;overflow-y:auto}
@keyframes up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mh{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.mt2{font-size:17px;font-weight:700}
.mcl{font-size:22px;color:var(--sub);cursor:pointer;line-height:1}

/* TOAST */
.toast{position:fixed;top:62px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.78);color:#fff;padding:10px 22px;border-radius:22px;font-size:14px;z-index:999;opacity:0;transition:opacity .3s;white-space:nowrap;pointer-events:none}
.toast.show{opacity:1}

/* EMPTY */
.empty{text-align:center;padding:52px 20px;color:var(--sub)}
.empty .ei{font-size:52px;margin-bottom:12px}
.empty p{font-size:14px;line-height:1.7}

/* LOADING */
.loading{position:fixed;inset:0;background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;z-index:500;flex-direction:column;gap:12px;font-size:14px;color:var(--sub)}
.loading.hidden{display:none}
.spinner{width:32px;height:32px;border:3px solid var(--bd);border-top-color:var(--g);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

input[type=file]{display:none}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading" id="loading"><div class="spinner"></div><span>åŠ è½½ä¸­â€¦</span></div>

<!-- AUTH SCREEN -->
<div id="authScreen">
  <div class="auth-logo">ğŸ’°</div>
  <div class="auth-title">é›¶é’±è®°è´¦</div>
  <div class="auth-sub">å¾®ä¿¡æ”¯ä»˜è‡ªåŠ¨åˆ†ç±»è®°è´¦</div>
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab on" onclick="authSwitch('login',this)">ç™»å½•</button>
      <button class="auth-tab" onclick="authSwitch('signup',this)">æ³¨å†Œ</button>
    </div>
    <input class="auth-inp" id="authEmail" type="email" placeholder="é‚®ç®±åœ°å€" autocomplete="email">
    <input class="auth-inp" id="authPwd" type="password" placeholder="å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" autocomplete="current-password">
    <div id="authName" style="display:none">
      <input class="auth-inp" id="authNameIn" type="text" placeholder="ä½ çš„æ˜µç§°ï¼ˆæ˜¾ç¤ºç”¨ï¼‰">
    </div>
    <button class="auth-btn" id="authBtn" onclick="doAuth()">ç™»å½•</button>
    <div class="auth-err" id="authErr"></div>
  </div>
  <div class="auth-footer">æ•°æ®éš”ç¦» Â· å„ç”¨ç‹¬ç«‹è´¦æœ¬<br>ç”± Supabase æä¾›å®‰å…¨è®¤è¯</div>
</div>

<!-- SETUP SCREEN (first time Supabase config) -->
<div id="setupScreen" class="hidden">
  <div class="setup-card">
    <h2>ğŸ”§ é¦–æ¬¡é…ç½®</h2>
    <p>è¯·å¡«å…¥ä½ çš„ Supabase é¡¹ç›®ä¿¡æ¯ã€‚åªéœ€é…ç½®ä¸€æ¬¡ï¼Œæ•°æ®å®‰å…¨å­˜å‚¨åœ¨ä½ è‡ªå·±çš„æ•°æ®åº“ã€‚</p>
    <p>æ²¡æœ‰ Supabase è´¦å·ï¼Ÿ<a class="setup-link" href="https://supabase.com" target="_blank">å…è´¹æ³¨å†Œ â†’</a></p>
    <br>
    <div class="fg">
      <label class="fl">Supabase Project URL</label>
      <input class="fi" id="sbUrl" placeholder="https://xxxx.supabase.co" autocomplete="off">
    </div>
    <div class="fg">
      <label class="fl">Supabase Anon Key</label>
      <input class="fi" id="sbKey" placeholder="eyJhbGciOi..." autocomplete="off">
    </div>
    <button class="btn bg" onclick="saveSupabaseConfig()">ä¿å­˜å¹¶ç»§ç»­</button>
    <div class="auth-err" id="setupErr"></div>
    <br>
    <p style="font-size:12px;color:var(--sub);line-height:1.7;margin-top:8px">
      åœ¨ Supabase é¡¹ç›®çš„ <strong>Project Settings â†’ API</strong> ä¸­æ‰¾åˆ°è¿™ä¸¤é¡¹ã€‚<br>
      é…ç½®å®Œæˆåè¯·æŒ‰ç…§ <strong>README.md</strong> åœ¨ Supabase ä¸­å»ºå¥½æ•°æ®è¡¨ã€‚
    </p>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">

<div class="hdr">
  <div class="hdr-top">
    <div class="hdr-title">ğŸ’° é›¶é’±è®°è´¦</div>
    <div class="hdr-user" onclick="showUserMenu()">
      <span>ğŸ‘¤</span><span id="userName">ç”¨æˆ·</span><span>â–¾</span>
    </div>
  </div>
  <div class="hdr-month" id="hdMonth">æœ¬æœˆæ”¯å‡º</div>
  <div class="hdr-amt"><em>Â¥</em><span id="hdAmt">0.00</span></div>
  <div class="hdr-row">
    <div><div class="sl">æ”¶å…¥</div><div class="sv" id="hdIn">Â¥0.00</div></div>
    <div><div class="sl">ç¬”æ•°</div><div class="sv" id="hdCnt">0ç¬”</div></div>
    <div><div class="sl">å‡€ç»“ä½™</div><div class="sv" id="hdNet">Â¥0.00</div></div>
  </div>
</div>

<div class="tabs">
  <div class="tab on" onclick="go('records')">æ˜ç»†</div>
  <div class="tab" onclick="go('stats')">ç»Ÿè®¡</div>
  <div class="tab" onclick="go('import')">å¯¼å…¥</div>
  <div class="tab" onclick="go('settings')">è®¾ç½®</div>
</div>

<!-- RECORDS -->
<div class="page on" id="pg-records">
  <div class="ms" id="mstrip"></div>
  <div class="cg" id="catGrid"></div>
  <div id="txBody"></div>
</div>

<!-- STATS -->
<div class="page" id="pg-stats">
  <div class="ms" id="mstrip2"></div>
  <div class="sw">
    <div class="sc"><div class="st">ğŸ“Š åˆ†ç±»æ”¯å‡º</div><div id="barChart"></div></div>
    <div class="sc"><div class="st">ğŸ“… è¿‘7å¤©è¶‹åŠ¿</div><div class="trnd" id="trend"></div></div>
    <div class="sc"><div class="st">ğŸ“† æœ¬æœˆçƒ­åŠ›å›¾</div><div class="cal" id="cal"></div></div>
  </div>
</div>

<!-- IMPORT -->
<div class="page" id="pg-import">
  <div class="iw">
    <div class="tip">
      <strong>ğŸ’¡ ä¸¤ç§å¯¼å…¥æ–¹å¼å‡æ”¯æŒ</strong>
      ä¸Šä¼ å¾®ä¿¡å®˜æ–¹è´¦å• CSVï¼ˆæœ€å…¨ï¼‰ï¼Œæˆ–ç²˜è´´å•æ¡æ”¯ä»˜é€šçŸ¥æ–‡å­—å¿«é€Ÿå½•å…¥ã€‚
    </div>

    <div class="ic">
      <h3>ğŸ“„ å¯¼å…¥å¾®ä¿¡è´¦å• CSV</h3>
      <p>é€‚åˆæ‰¹é‡è¡¥å½•å†å²æ•°æ®ï¼Œä¸€æ¬¡å¯¼å…¥æ‰€æœ‰è®°å½•ã€‚</p>
      <div class="steps">
        <div class="step"><div class="sn">1</div><div>å¾®ä¿¡ â†’ æˆ‘ â†’ æœåŠ¡ â†’ é’±åŒ…</div></div>
        <div class="step"><div class="sn">2</div><div>å³ä¸Šè§’ã€Œè´¦å•ã€â†’ã€Œå¸¸è§é—®é¢˜ã€â†’ã€Œç”³è¯·è´¦å•ã€</div></div>
        <div class="step"><div class="sn">3</div><div>é€‰æ—¶é—´èŒƒå›´ï¼Œé‚®ä»¶æ”¶åˆ°åä¸‹è½½ CSV</div></div>
        <div class="step"><div class="sn">4</div><div>ç‚¹ä¸‹æ–¹æŒ‰é’®ä¸Šä¼ æ–‡ä»¶ï¼Œè‡ªåŠ¨è§£æåˆ†ç±»</div></div>
      </div>
      <button class="btn bg" onclick="document.getElementById('csvFile').click()">ğŸ“‚ é€‰æ‹© CSV æ–‡ä»¶</button>
      <input type="file" id="csvFile" accept=".csv,.CSV" onchange="importCSV(event)">
    </div>

    <div class="ic">
      <h3>âœï¸ ç²˜è´´æ”¯ä»˜é€šçŸ¥</h3>
      <p>æŠŠå¾®ä¿¡æ”¯ä»˜é€šçŸ¥æ–‡å­—ç²˜è´´è¿›æ¥ï¼Œè‡ªåŠ¨è¯†åˆ«é‡‘é¢å’Œåˆ†ç±»ï¼Œå¿«é€Ÿå½•å…¥å•æ¡ã€‚</p>
      <textarea class="fi" id="notifTxt" rows="3" placeholder="ä¾‹ï¼šå¾®ä¿¡æ”¯ä»˜æˆåŠŸï¼Œä»˜æ¬¾ Â¥28.50ï¼Œå•†æˆ·ï¼šç‘å¹¸å’–å•¡"></textarea>
      <br><br>
      <button class="btn bo" onclick="parseNotif()">ğŸ” è§£æå¹¶å¯¼å…¥</button>
    </div>

    <div class="ic">
      <h3>ğŸ”— Webhook è‡ªåŠ¨æ¥æ”¶</h3>
      <p>é…åˆ Androidã€Œé€šçŸ¥è½¬å‘ã€ç±» Appï¼ˆå¦‚ <strong>Tasker</strong> / <strong>MacroDroid</strong>ï¼‰ï¼Œç›‘å¬åˆ°å¾®ä¿¡æ”¯ä»˜é€šçŸ¥åè‡ªåŠ¨ POST åˆ°ä¸‹æ–¹åœ°å€ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œã€‚</p>
      <div class="fg">
        <label class="fl">ä½ çš„ä¸“å± Webhook åœ°å€ï¼ˆç‚¹å‡»å¤åˆ¶ï¼‰</label>
        <div class="webhook-box" id="webhookUrl" onclick="copyWebhook()">ç™»å½•åè‡ªåŠ¨ç”Ÿæˆ</div>
      </div>
      <div class="fg">
        <label class="fl">POST Body æ ¼å¼ï¼ˆJSONï¼‰</label>
        <div class="webhook-box">{"text": "å¾®ä¿¡æ”¯ä»˜æˆåŠŸï¼Œä»˜æ¬¾Â¥28.50ï¼Œå•†æˆ·ï¼šç‘å¹¸å’–å•¡"}</div>
      </div>
      <button class="btn bo" onclick="go('settings');setTimeout(()=>document.getElementById('webhookSection').scrollIntoView({behavior:'smooth'}),300)">âš™ï¸ åœ¨è®¾ç½®é¡µæŸ¥çœ‹å®Œæ•´é…ç½®</button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div class="page" id="pg-settings">
  <div class="setw">

    <div class="setl">ğŸ‘¤ è´¦æˆ·</div>
    <div class="setg">
      <div class="setr" onclick="editNickname()">
        <div class="setico">âœï¸</div>
        <div class="setinfo"><div class="setname">ä¿®æ”¹æ˜µç§°</div><div class="setsub" id="nicknameShow">-</div></div>
        <div>â€º</div>
      </div>
      <div class="setr" onclick="changePassword()">
        <div class="setico">ğŸ”‘</div>
        <div class="setinfo"><div class="setname">ä¿®æ”¹å¯†ç </div><div class="setsub">é€šè¿‡é‚®ä»¶é‡ç½®</div></div>
        <div>â€º</div>
      </div>
      <div class="setr" onclick="signOut()">
        <div class="setico">ğŸšª</div>
        <div class="setinfo"><div class="setname" style="color:var(--r)">é€€å‡ºç™»å½•</div><div class="setsub" id="userEmailShow">-</div></div>
        <div>â€º</div>
      </div>
    </div>

    <div class="setl" id="webhookSection">ğŸ”— Webhook è‡ªåŠ¨æ¥æ”¶é…ç½®</div>
    <div class="setc">
      <h3>Tasker / MacroDroid é…ç½®</h3>
      <p style="font-size:13px;color:var(--sub);line-height:1.7;margin-bottom:14px">Android ä¸Šå…è´¹çš„ <strong>MacroDroid</strong> å¯ä»¥ç›‘å¬å¾®ä¿¡é€šçŸ¥ï¼Œè‡ªåŠ¨ POST åˆ°ä½ çš„ä¸“å±åœ°å€ã€‚</p>
      <div class="steps">
        <div class="step"><div class="sn">1</div><div>å®‰è£… MacroDroidï¼ˆGoogle Play å…è´¹ç‰ˆå³å¯ï¼‰</div></div>
        <div class="step"><div class="sn">2</div><div>æ–°å»ºå® â†’ è§¦å‘å™¨ï¼šã€Œé€šçŸ¥å·²æ”¶åˆ°ã€â†’ åº”ç”¨é€‰ã€Œå¾®ä¿¡ã€</div></div>
        <div class="step"><div class="sn">3</div><div>åŠ¨ä½œï¼šã€ŒHTTP è¯·æ±‚ã€â†’ Method: POSTï¼ŒURL å¡«å…¥ä¸‹æ–¹åœ°å€</div></div>
        <div class="step"><div class="sn">4</div><div>Body: <code>{"text": "[è§¦å‘å™¨å˜é‡: é€šçŸ¥å†…å®¹]"}</code></div></div>
        <div class="step"><div class="sn">5</div><div>ä¿å­˜å®ï¼Œå¼€å¯ã€Œé€šçŸ¥ä½¿ç”¨æƒã€æƒé™</div></div>
      </div>
      <label class="fl">ä½ çš„ä¸“å± Webhook URLï¼ˆç‚¹å‡»å¤åˆ¶ï¼‰</label>
      <div class="webhook-box" id="webhookUrl2" onclick="copyWebhook()">ç™»å½•åè‡ªåŠ¨ç”Ÿæˆ</div>
      <button class="btn bo" onclick="testWebhook()">ğŸ§ª æµ‹è¯• Webhook</button>
    </div>

    <div class="setl">ğŸ·ï¸ åˆ†ç±»å…³é”®è¯ç®¡ç†</div>
    <div class="setc">
      <h3>è‡ªå®šä¹‰è¯†åˆ«è§„åˆ™</h3>
      <p style="font-size:13px;color:var(--sub);line-height:1.7;margin-bottom:14px">ä¸ºæ¯ä¸ªåˆ†ç±»æ·»åŠ è‡ªå®šä¹‰å…³é”®è¯ï¼ŒåŒ¹é…å•†å®¶åç§°æ—¶è‡ªåŠ¨å½’ç±»ã€‚</p>
      <div id="rulesEditor"></div>
      <button class="btn bo" onclick="saveCustomRules()">ğŸ’¾ ä¿å­˜è§„åˆ™</button>
    </div>

    <div class="setl">ğŸ“¦ æ•°æ®ç®¡ç†</div>
    <div class="setg">
      <div class="setr" onclick="exportJSON()">
        <div class="setico">ğŸ“¤</div>
        <div class="setinfo"><div class="setname">å¯¼å‡º JSON å¤‡ä»½</div><div class="setsub" id="recCnt">å…± 0 æ¡</div></div>
        <div>â€º</div>
      </div>
      <div class="setr" onclick="document.getElementById('jsonFile').click()">
        <div class="setico">ğŸ“¥</div>
        <div class="setinfo"><div class="setname">ä» JSON æ¢å¤</div><div class="setsub">åˆå¹¶å¯¼å…¥ï¼Œè‡ªåŠ¨å»é‡</div></div>
        <div>â€º</div>
      </div>
      <div class="setr" onclick="clearAll()">
        <div class="setico">ğŸ—‘ï¸</div>
        <div class="setinfo"><div class="setname" style="color:var(--r)">æ¸…é™¤æˆ‘çš„æ‰€æœ‰æ•°æ®</div><div class="setsub">åªåˆ é™¤å½“å‰è´¦æˆ·æ•°æ®</div></div>
        <div>â€º</div>
      </div>
    </div>

    <div style="text-align:center;padding:10px 0 4px;font-size:12px;color:#ccc">
      é›¶é’±è®°è´¦ Â· å¤šç”¨æˆ·ç‰ˆ Â· Powered by Supabase
    </div>
  </div>
  <input type="file" id="jsonFile" accept=".json" onchange="restoreJSON(event)" style="display:none">
</div>

</div><!-- /app -->

<button class="fab" id="fab" onclick="openAdd()" style="display:none">+</button>

<div class="bnav" id="bnav" style="display:none">
  <div class="ni on" onclick="go('records')"><div class="nico">ğŸ“‹</div><div class="nlbl">æ˜ç»†</div></div>
  <div class="ni" onclick="go('stats')"><div class="nico">ğŸ“Š</div><div class="nlbl">ç»Ÿè®¡</div></div>
  <div class="ni" onclick="go('import')"><div class="nico">ğŸ“¥</div><div class="nlbl">å¯¼å…¥</div></div>
  <div class="ni" onclick="go('settings')"><div class="nico">âš™ï¸</div><div class="nlbl">è®¾ç½®</div></div>
</div>

<!-- ADD MODAL -->
<div class="ov" id="addOv" onclick="maybeCloseAdd(event)">
  <div class="modal">
    <div class="mh"><div class="mt2">æ·»åŠ è®°å½•</div><div class="mcl" onclick="closeAdd()">Ã—</div></div>
    <div class="tyr">
      <button class="tyb on" onclick="setType('out',this)">æ”¯å‡º</button>
      <button class="tyb" onclick="setType('in',this)">æ”¶å…¥</button>
    </div>
    <div class="fg"><label class="fl">é‡‘é¢ï¼ˆå…ƒï¼‰</label>
      <input class="fi" id="amtIn" type="number" placeholder="0.00" step="0.01" min="0.01" inputmode="decimal"></div>
    <div class="fg"><label class="fl">æè¿°ï¼ˆè‡ªåŠ¨è¯†åˆ«åˆ†ç±»ï¼‰</label>
      <input class="fi" id="descIn" type="text" placeholder="å•†å®¶åç§° / å¤‡æ³¨â€¦"></div>
    <div class="fg"><label class="fl">åˆ†ç±»</label><div class="cp" id="cpick"></div></div>
    <div class="fg"><label class="fl">æ—¶é—´</label>
      <input class="fi" id="dtIn" type="datetime-local"></div>
    <button class="btn bg" onclick="addRec()">âœ“ ä¿å­˜</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sb = null;
let currentUser = null;

function getConfig() {
  return {
    url: localStorage.getItem('sb_url') || '',
    key: localStorage.getItem('sb_key') || ''
  };
}

function initSupabase() {
  const { url, key } = getConfig();
  if (!url || !key) return false;
  try {
    sb = supabase.createClient(url, key);
    return true;
  } catch(e) { return false; }
}

async function boot() {
  document.getElementById('loading').classList.remove('hidden');

  if (!initSupabase()) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('setupScreen').classList.remove('hidden');
    document.getElementById('authScreen').classList.add('hidden');
    return;
  }

  // Check session
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    currentUser = session.user;
    await showApp();
  } else {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('authScreen').classList.remove('hidden');
  }
}

function saveSupabaseConfig() {
  const url = document.getElementById('sbUrl').value.trim();
  const key = document.getElementById('sbKey').value.trim();
  if (!url.startsWith('https://') || !key.startsWith('eyJ')) {
    document.getElementById('setupErr').textContent = 'URL æˆ– Key æ ¼å¼ä¸å¯¹ï¼Œè¯·æ£€æŸ¥';
    return;
  }
  localStorage.setItem('sb_url', url);
  localStorage.setItem('sb_key', key);
  if (initSupabase()) {
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('authScreen').classList.remove('hidden');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let authMode = 'login';
function authSwitch(mode, btn) {
  authMode = mode;
  document.querySelectorAll('.auth-tab').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  document.getElementById('authName').style.display = mode === 'signup' ? 'block' : 'none';
  document.getElementById('authBtn').textContent = mode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ';
  document.getElementById('authErr').textContent = '';
}

async function doAuth() {
  const email = document.getElementById('authEmail').value.trim();
  const pwd = document.getElementById('authPwd').value;
  const name = document.getElementById('authNameIn').value.trim();
  const errEl = document.getElementById('authErr');
  errEl.textContent = '';

  if (!email || !pwd) { errEl.textContent = 'è¯·å¡«å†™é‚®ç®±å’Œå¯†ç '; return; }
  if (authMode === 'signup' && !name) { errEl.textContent = 'è¯·å¡«å†™æ˜µç§°'; return; }

  document.getElementById('authBtn').textContent = 'è¯·ç¨å€™â€¦';

  try {
    if (authMode === 'login') {
      const { data, error } = await sb.auth.signInWithPassword({ email, password: pwd });
      if (error) throw error;
      currentUser = data.user;
    } else {
      const { data, error } = await sb.auth.signUp({
        email, password: pwd,
        options: { data: { nickname: name } }
      });
      if (error) throw error;
      if (!data.session) {
        errEl.style.color = 'var(--g)';
        errEl.textContent = 'æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±éªŒè¯åç™»å½•';
        document.getElementById('authBtn').textContent = 'æ³¨å†Œ';
        return;
      }
      currentUser = data.user;
    }
    await showApp();
  } catch(e) {
    errEl.style.color = 'var(--r)';
    const msg = e.message || '';
    if (msg.includes('Invalid login')) errEl.textContent = 'é‚®ç®±æˆ–å¯†ç é”™è¯¯';
    else if (msg.includes('already registered')) errEl.textContent = 'è¯¥é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•';
    else errEl.textContent = msg;
    document.getElementById('authBtn').textContent = authMode === 'login' ? 'ç™»å½•' : 'æ³¨å†Œ';
  }
}

// Enter key support
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !document.getElementById('authScreen').classList.contains('hidden')) doAuth();
});

async function showApp() {
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('app').style.display = 'block';
  document.getElementById('bnav').style.display = 'flex';
  document.getElementById('fab').style.display = 'flex';

  const nickname = currentUser.user_metadata?.nickname || currentUser.email?.split('@')[0] || 'ç”¨æˆ·';
  document.getElementById('userName').textContent = nickname;
  document.getElementById('nicknameShow').textContent = nickname;
  document.getElementById('userEmailShow').textContent = currentUser.email;

  // Set webhook URL
  const whUrl = `${getConfig().url}/functions/v1/webhook?uid=${currentUser.id}`;
  document.getElementById('webhookUrl').textContent = whUrl;
  document.getElementById('webhookUrl2').textContent = whUrl;

  await loadRecs();
  renderRulesEditor();
}

function showUserMenu() {
  if (confirm(`è´¦æˆ·ï¼š${currentUser.email}\n\nç‚¹ç¡®å®šé€€å‡ºç™»å½•`)) signOut();
}
async function signOut() {
  await sb.auth.signOut();
  currentUser = null; recs = [];
  document.getElementById('app').style.display = 'none';
  document.getElementById('bnav').style.display = 'none';
  document.getElementById('fab').style.display = 'none';
  document.getElementById('authScreen').classList.remove('hidden');
}
async function changePassword() {
  const { error } = await sb.auth.resetPasswordForEmail(currentUser.email);
  if (error) toast('å‘é€å¤±è´¥ï¼š' + error.message);
  else toast('é‡ç½®å¯†ç é‚®ä»¶å·²å‘é€ï¼Œè¯·æŸ¥æ”¶');
}
async function editNickname() {
  const name = prompt('ä¿®æ”¹æ˜µç§°ï¼š', document.getElementById('nicknameShow').textContent);
  if (!name) return;
  const { error } = await sb.auth.updateUser({ data: { nickname: name } });
  if (error) { toast('ä¿®æ”¹å¤±è´¥'); return; }
  document.getElementById('userName').textContent = name;
  document.getElementById('nicknameShow').textContent = name;
  toast('æ˜µç§°å·²æ›´æ–°');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CATEGORIES & RULES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CATS = [
  { id:'food',  name:'é¤é¥®',    icon:'ğŸœ', color:'#ff9500', bg:'#fff4e5' },
  { id:'life',  name:'ç”Ÿæ´»æ—¥ç”¨',icon:'ğŸ›’', color:'#34aadc', bg:'#e5f5fc' },
  { id:'trans', name:'äº¤é€š',    icon:'ğŸšŒ', color:'#5856d6', bg:'#eeeeff' },
  { id:'xfer',  name:'è½¬è´¦',    icon:'ğŸ’¸', color:'#ff5e57', bg:'#fff0ee' },
  { id:'red',   name:'çº¢åŒ…',    icon:'ğŸ§§', color:'#c0392b', bg:'#fef0ee' },
  { id:'other', name:'æ¶ˆè´¹',    icon:'ğŸ’³', color:'#8e8e93', bg:'#f2f2f7' },
];
const CM = Object.fromEntries(CATS.map(c => [c.id, c]));

const DEFAULT_KW = {
  food:  'é¤ é¥­ é£Ÿ èŒ¶ é¥® å’–å•¡ å¥¶èŒ¶ çƒ§çƒ¤ ç«é”… å¤–å– ç¾å›¢ é¥¿äº†ä¹ˆ éº¦å½“åŠ³ è‚¯å¾·åŸº æ˜Ÿå·´å…‹ ç‘å¹¸ èœœé›ª èŒ¶ç™¾é“ æµ·åº•æ å°åƒ é¢é¦† ç²¥ å¯¿å¸ æŠ«è¨ æ—©é¤ åˆé¤ æ™šé¤ å®µå¤œ é¢åŒ… è›‹ç³• å¿«é¤ ç‚¸é¸¡ æ±‰å ¡ ç”œå“ å†°æ·‡æ·‹',
  life:  'è¶…å¸‚ ä¾¿åˆ©åº— è¯åº— è¯æˆ¿ ç†å‘ å‘å»Š ç¾å®¹ ç¾ç”² æ´—è¡£ æ°´ç”µ ç‰©ä¸š è´­ç‰© è¡£æœ æœè£… é‹ æ—¥ç”¨ ç”Ÿæ´» æ²ƒå°”ç› æ°¸è¾‰ ç›’é©¬ äº¬ä¸œ æ·˜å® æ‹¼å¤šå¤š å®å’š 711 å…¨å®¶ ç½—æ£® å®¶ä¹ç¦ è¯è´¹ å®½å¸¦ æµé‡',
  trans: 'åœ°é“ å…¬äº¤ æ‰“è½¦ æ»´æ»´ å‡ºç§Ÿ é«˜é“ ç«è½¦ é£æœº æœºç¥¨ èˆªç©º åŠ æ²¹ åœè½¦ å•è½¦ æ‘©æ‹œ å“ˆå•° é«˜é€Ÿ ETC äº¤é€š',
  xfer:  'è½¬è´¦ è½¬ç»™ æ±‡æ¬¾ è¿˜æ¬¾ å€Ÿæ¬¾ è¿˜ä½ ',
  red:   'çº¢åŒ…',
};

let customKW = JSON.parse(localStorage.getItem('customKW') || '{}');

function getKW(catId) {
  const base = (DEFAULT_KW[catId] || '').split(' ').filter(Boolean);
  const custom = (customKW[catId] || '').split(/[,ï¼Œ\s]+/).filter(Boolean);
  return [...new Set([...base, ...custom])];
}

function guess(t = '') {
  const cats = ['red','xfer','food','life','trans'];
  for (const id of cats) {
    if (getKW(id).some(k => t.includes(k))) return id;
  }
  return 'other';
}

function renderRulesEditor() {
  const cats = CATS.filter(c => c.id !== 'other');
  document.getElementById('rulesEditor').innerHTML = cats.map(c => `
    <div style="margin-bottom:12px">
      <label class="fl">${c.icon} ${c.name} â€” è‡ªå®šä¹‰å…³é”®è¯ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
      <input class="fi" id="kw_${c.id}" placeholder="å¦‚ï¼šæ‹‰é¢ã€ä¾¿å½“ã€ç…²ä»”é¥­â€¦"
        value="${customKW[c.id] || ''}" style="font-size:13px;padding:10px 12px">
    </div>`).join('');
}

function saveCustomRules() {
  CATS.filter(c => c.id !== 'other').forEach(c => {
    customKW[c.id] = document.getElementById('kw_' + c.id).value.trim();
  });
  localStorage.setItem('customKW', JSON.stringify(customKW));
  toast('è§„åˆ™å·²ä¿å­˜ âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA (Supabase)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let recs = [];
let curM = new Date().toISOString().slice(0, 7);
let txT = 'out', selC = 'other', filtC = null;

async function loadRecs() {
  if (!sb || !currentUser) return;
  const { data, error } = await sb.from('records')
    .select('*').eq('user_id', currentUser.id).order('date', { ascending: false });
  if (error) { toast('åŠ è½½å¤±è´¥ï¼š' + error.message); return; }
  recs = data || [];
  render();
}

async function insertRec(rec) {
  const payload = { ...rec, user_id: currentUser.id };
  const { data, error } = await sb.from('records').insert([payload]).select().single();
  if (error) throw error;
  recs.unshift(data);
  render();
  return data;
}

async function deleteRec(id) {
  const { error } = await sb.from('records').delete().eq('id', id).eq('user_id', currentUser.id);
  if (error) { toast('åˆ é™¤å¤±è´¥'); return; }
  recs = recs.filter(r => r.id !== id);
  render();
  toast('å·²åˆ é™¤');
}

async function bulkInsert(newRecs) {
  const payloads = newRecs.map(r => ({ ...r, user_id: currentUser.id }));
  const { data, error } = await sb.from('records').insert(payloads).select();
  if (error) throw error;
  recs.push(...(data || []));
  render();
  return data?.length || 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getMonths() {
  const s = new Set(recs.map(r => (r.date||'').slice(0,7)));
  s.add(new Date().toISOString().slice(0,7));
  return [...s].sort().reverse().slice(0,6);
}
function mLabel(m) {
  const [y,mo] = m.split('-');
  return y === String(new Date().getFullYear()) ? `${+mo}æœˆ` : `${y}/${+mo}æœˆ`;
}
function renderStrips() {
  const h = getMonths().map(m =>
    `<div class="mc ${m===curM?'on':''}" onclick="setM('${m}')">${mLabel(m)}</div>`).join('');
  document.getElementById('mstrip').innerHTML = h;
  document.getElementById('mstrip2').innerHTML = h;
}
function setM(m) { curM=m; filtC=null; render(); }

function render() {
  renderStrips();
  const all = recs.filter(r => (r.date||'').startsWith(curM));
  const out = all.filter(r => r.type==='out');
  const inn = all.filter(r => r.type==='in');
  const tO = out.reduce((s,r)=>s+r.amount,0);
  const tI = inn.reduce((s,r)=>s+r.amount,0);
  const isThis = curM === new Date().toISOString().slice(0,7);
  const [y,mo] = curM.split('-');
  document.getElementById('hdMonth').textContent = isThis ? 'æœ¬æœˆæ”¯å‡º' : `${y}å¹´${+mo}æœˆæ”¯å‡º`;
  document.getElementById('hdAmt').textContent = tO.toFixed(2);
  document.getElementById('hdIn').textContent = 'Â¥'+tI.toFixed(2);
  document.getElementById('hdCnt').textContent = all.length+'ç¬”';
  document.getElementById('hdNet').textContent = 'Â¥'+(tI-tO).toFixed(2);
  document.getElementById('recCnt').textContent = `å…± ${recs.length} æ¡`;
  renderGrid(out);
  renderList(filtC ? all.filter(r=>r.cat===filtC) : all);
  renderStats(all);
}

function renderGrid(out) {
  const t={}; CATS.forEach(c=>t[c.id]=0);
  out.forEach(r=>t[r.cat]=(t[r.cat]||0)+r.amount);
  document.getElementById('catGrid').innerHTML = CATS.map(c =>
    `<div class="cc ${filtC&&filtC!==c.id?'dim':''}" onclick="filt('${c.id}')">
      <div class="ci">${c.icon}</div><div class="cn">${c.name}</div>
      <div class="ca" style="color:${c.color}">Â¥${t[c.id].toFixed(0)}</div>
    </div>`).join('');
}
function filt(id) {
  filtC = filtC===id ? null : id;
  const all = recs.filter(r=>(r.date||'').startsWith(curM));
  renderGrid(all.filter(r=>r.type==='out'));
  renderList(filtC ? all.filter(r=>r.cat===filtC) : all);
}

function renderList(data) {
  const body = document.getElementById('txBody');
  if (!data.length) {
    body.innerHTML = `<div class="empty"><div class="ei">ğŸ“‹</div><p>æš‚æ— è®°å½•<br>å³ä¸‹è§’ <strong>+</strong> æ‰‹åŠ¨æ·»åŠ <br>æˆ–åœ¨ã€Œå¯¼å…¥ã€é¡µå¯¼å…¥å¾®ä¿¡è´¦å•</p></div>`;
    return;
  }
  const sorted = [...data].sort((a,b)=>new Date(b.date)-new Date(a.date));
  const todayStr = new Date().toISOString().slice(0,10);
  const yestStr = (() => { const d=new Date();d.setDate(d.getDate()-1);return d.toISOString().slice(0,10); })();
  let html='', lastDay='';
  sorted.forEach(r => {
    const day = (r.date||'').slice(0,10);
    if (day!==lastDay) {
      const lbl = day===todayStr?'ä»Šå¤©':day===yestStr?'æ˜¨å¤©':day.slice(5).replace('-','/');
      const dayOut = sorted.filter(x=>x.date?.slice(0,10)===day&&x.type==='out').reduce((s,x)=>s+x.amount,0);
      html += `<div class="dl"><span>${lbl}</span><span style="font-size:11px">æ”¯å‡º Â¥${dayOut.toFixed(2)}</span></div>`;
      lastDay = day;
    }
    const c = CM[r.cat]||CM.other;
    const d = new Date(r.date);
    const tm = `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
    html += `<div class="tl"><div class="tc" style="--ac:${c.color}" onclick="confirmDel('${r.id}')">
      <div class="tci" style="background:${c.bg}">${c.icon}</div>
      <div class="tin"><div class="tn">${r.desc||c.name}</div><div class="tm">${tm} Â· ${c.name}</div></div>
      <div class="ta ${r.type}">${r.type==='in'?'+':'-'}Â¥${r.amount.toFixed(2)}</div>
    </div></div>`;
  });
  body.innerHTML = html;
}

function confirmDel(id) {
  const r = recs.find(x=>x.id===id);
  if (!r) return;
  if (confirm(`åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ\n${r.desc||'æ— æè¿°'}  Â¥${r.amount.toFixed(2)}`)) deleteRec(id);
}

function renderStats(all) {
  const out = all.filter(r=>r.type==='out');
  const t={}; CATS.forEach(c=>t[c.id]=0);
  out.forEach(r=>t[r.cat]=(t[r.cat]||0)+r.amount);
  const total = out.reduce((s,r)=>s+r.amount,0)||1;
  document.getElementById('barChart').innerHTML = CATS.map(c => {
    const p = ((t[c.id]/total)*100).toFixed(1);
    return `<div class="br"><div class="bh"><span>${c.icon} ${c.name}</span><span style="color:${c.color}">Â¥${t[c.id].toFixed(2)} <small style="color:var(--sub)">${p}%</small></span></div><div class="bt"><div class="bf" style="width:${p}%;background:${c.color}"></div></div></div>`;
  }).join('');

  const tr={}; for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);tr[d.toISOString().slice(0,10)]=0;}
  out.forEach(r=>{const k=(r.date||'').slice(0,10);if(k in tr)tr[k]+=r.amount;});
  const mx=Math.max(...Object.values(tr))||1;
  document.getElementById('trend').innerHTML = Object.entries(tr).map(([d,v])=>
    `<div class="tc2"><div class="tbw"><div class="tb" style="height:${Math.max(3,(v/mx)*100)}%"></div></div><div class="tl2">${d.slice(8)}</div></div>`).join('');

  const [y,mo]=curM.split('-').map(Number);
  const dim=new Date(y,mo,0).getDate(), fd=new Date(y,mo-1,1).getDay();
  const dt={}; out.filter(r=>(r.date||'').startsWith(curM)).forEach(r=>{const d=+r.date.slice(8,10);dt[d]=(dt[d]||0)+r.amount;});
  const mdv=Math.max(...Object.values(dt))||1;
  const today=new Date().getDate(), isThisM=curM===new Date().toISOString().slice(0,7);
  let ch=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(h=>`<div class="chd">${h}</div>`).join('');
  for(let i=0;i<fd;i++)ch+='<div></div>';
  for(let d=1;d<=dim;d++){const v=dt[d]||0;const op=v?Math.max(.1,v/mdv):0;const isTd=isThisM&&d===today;
    ch+=`<div class="cd" title="${d}æ—¥ Â¥${v.toFixed(0)}" style="background:${v?`rgba(7,193,96,${op})`:'#f2f2f7'};${isTd?'outline:2px solid var(--g);':''}color:${v>mdv*.6?'#fff':'var(--sub)'}">${d}</div>`;}
  document.getElementById('cal').innerHTML = ch;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PAGES = ['records','stats','import','settings'];
function go(p) {
  PAGES.forEach(id=>{document.getElementById('pg-'+id).classList.toggle('on',id===p);});
  document.querySelectorAll('.tab').forEach((el,i)=>el.classList.toggle('on',PAGES[i]===p));
  document.querySelectorAll('.ni').forEach((el,i)=>el.classList.toggle('on',PAGES[i]===p));
  document.getElementById('fab').style.display=(p==='records'||p==='import')?'flex':'none';
  if(p!=='settings')render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADD RECORD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAdd() {
  document.getElementById('addOv').classList.add('open');
  const n=new Date();n.setMinutes(n.getMinutes()-n.getTimezoneOffset());
  document.getElementById('dtIn').value=n.toISOString().slice(0,16);
  selC='other'; renderCpick();
}
function closeAdd(){document.getElementById('addOv').classList.remove('open');}
function maybeCloseAdd(e){if(e.target===document.getElementById('addOv'))closeAdd();}
function setType(t,btn){txT=t;document.querySelectorAll('.tyb').forEach(b=>b.classList.remove('on'));btn.classList.add('on');}
function renderCpick(){
  document.getElementById('cpick').innerHTML=CATS.map(c=>
    `<button class="cpb ${selC===c.id?'on':''}" onclick="pickC('${c.id}',this)"><span class="cpi">${c.icon}</span><span class="cpl">${c.name}</span></button>`).join('');
}
function pickC(id,btn){selC=id;document.querySelectorAll('.cpb').forEach(b=>b.classList.remove('on'));btn.classList.add('on');}
document.getElementById('descIn').addEventListener('input',function(){selC=guess(this.value);renderCpick();});

async function addRec() {
  const amt=parseFloat(document.getElementById('amtIn').value);
  const desc=document.getElementById('descIn').value.trim();
  const date=document.getElementById('dtIn').value;
  if(!amt||amt<=0){toast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');return;}
  if(!date){toast('è¯·é€‰æ‹©æ—¶é—´');return;}
  const cat=selC==='other'?guess(desc):selC;
  try {
    await insertRec({amount:amt,desc,cat,type:txT,date});
    closeAdd();
    document.getElementById('amtIn').value='';
    document.getElementById('descIn').value='';
    toast((txT==='in'?'æ”¶å…¥ +':'æ”¯å‡º -')+'Â¥'+amt.toFixed(2)+' å·²è®°å½•');
  } catch(e){toast('ä¿å­˜å¤±è´¥ï¼š'+e.message);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSV IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function importCSV(e) {
  const f=e.target.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onload=async ev=>{
    try{
      const parsed=parseWxCSV(ev.target.result);
      if(!parsed.length){toast('æœªæ‰¾åˆ°æœ‰æ•ˆè®°å½•');return;}
      // Dedup by date+amount
      const ex=new Set(recs.map(r=>`${(r.date||'').slice(0,16)}|${r.amount}`));
      const nw=parsed.filter(r=>!ex.has(`${r.date.slice(0,16)}|${r.amount}`));
      if(!nw.length){toast('æ‰€æœ‰è®°å½•å·²å­˜åœ¨ï¼Œæ— éœ€å¯¼å…¥');return;}
      const n=await bulkInsert(nw);
      toast(`æˆåŠŸå¯¼å…¥ ${n} æ¡ï¼Œè·³è¿‡ ${parsed.length-nw.length} æ¡é‡å¤`);
    }catch(err){toast('è§£æ/å¯¼å…¥å¤±è´¥ï¼š'+err.message);}
  };
  reader.readAsText(f,'UTF-8');e.target.value='';
}

function parseWxCSV(raw){
  const text=raw.replace(/^\uFEFF/,'');
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
  let hi=-1;
  for(let i=0;i<lines.length;i++){if(lines[i].includes('äº¤æ˜“æ—¶é—´')&&lines[i].includes('é‡‘é¢')){hi=i;break;}}
  if(hi<0)throw new Error('æ‰¾ä¸åˆ°è¡¨å¤´ï¼ˆéœ€å«"äº¤æ˜“æ—¶é—´"å’Œ"é‡‘é¢"ï¼‰');
  const pr=line=>{const cs=[];let c='',q=false;for(const ch of line){if(ch==='"')q=!q;else if(ch===','&&!q){cs.push(c.trim());c='';}else c+=ch;}cs.push(c.trim());return cs;};
  const hds=pr(lines[hi]);
  const gi=n=>hds.findIndex(h=>h.includes(n));
  const cD=gi('äº¤æ˜“æ—¶é—´'),cT=gi('æ”¶/æ”¯'),cA=gi('é‡‘é¢'),cP=gi('äº¤æ˜“å¯¹æ–¹'),cG=gi('å•†å“'),cS=gi('å½“å‰çŠ¶æ€');
  const res=[];
  for(let i=hi+1;i<lines.length;i++){
    const cs=pr(lines[i]);if(cs.length<4)continue;
    if(cS>=0&&(cs[cS]||'').includes('é€€æ¬¾'))continue;
    const amt=parseFloat((cs[cA]||'').replace(/[Â¥,\s]/g,''));
    if(isNaN(amt)||amt<=0)continue;
    const type=(cs[cT]||'').includes('æ”¶å…¥')?'in':'out';
    const peer=cs[cP]||'',goods=cs[cG]||'';
    const desc=[peer,goods].filter(x=>x&&x!=='/'&&x!=='æ— ').join(' ').trim();
    res.push({amount:amt,desc,cat:guess(desc),type,date:(cs[cD]||'').replace(/\//g,'-')});
  }
  return res;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTIF TEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function parseNotif(){
  const t=document.getElementById('notifTxt').value.trim();
  if(!t){toast('è¯·ç²˜è´´é€šçŸ¥æ–‡æœ¬');return;}
  const m=t.match(/[Â¥ï¿¥](\d+\.?\d*)/);
  if(!m){toast('æœªè¯†åˆ«åˆ°é‡‘é¢');return;}
  const amt=parseFloat(m[1]);
  const type=(t.includes('æ”¶æ¬¾')||t.includes('æ”¶åˆ°'))&&!t.includes('ä½ å·²æ”¯ä»˜')?'in':'out';
  const cat=t.includes('çº¢åŒ…')?'red':t.includes('è½¬è´¦')?'xfer':guess(t);
  try{
    await insertRec({amount:amt,desc:t.slice(0,60),cat,type,date:new Date().toISOString()});
    document.getElementById('notifTxt').value='';
    toast((type==='in'?'æ”¶å…¥ +':'æ”¯å‡º -')+'Â¥'+amt.toFixed(2)+' å·²å¯¼å…¥');
  }catch(e){toast('ä¿å­˜å¤±è´¥ï¼š'+e.message);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEBHOOK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyWebhook(){
  const url=document.getElementById('webhookUrl').textContent;
  navigator.clipboard?.writeText(url).then(()=>toast('Webhook URL å·²å¤åˆ¶')).catch(()=>toast('è¯·é•¿æŒ‰æ‰‹åŠ¨å¤åˆ¶'));
}

async function testWebhook(){
  // Simulate a test record
  try{
    await insertRec({amount:0.01,desc:'Webhook æµ‹è¯•',cat:'other',type:'out',date:new Date().toISOString()});
    toast('âœ“ æµ‹è¯•è®°å½•å·²å†™å…¥ï¼ŒWebhook é…ç½®æ­£å¸¸');
  }catch(e){toast('æµ‹è¯•å¤±è´¥ï¼š'+e.message);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA EXPORT / RESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportJSON(){
  const blob=new Blob([JSON.stringify({records:recs,exportedAt:new Date().toISOString()},null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='é›¶é’±è®°è´¦_'+currentUser.email+'_'+new Date().toISOString().slice(0,10)+'.json';a.click();
}
function restoreJSON(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=async ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      const imp=d.records||d;
      if(!Array.isArray(imp))throw 0;
      const ex=new Set(recs.map(x=>`${(x.date||'').slice(0,16)}|${x.amount}`));
      const nw=imp.filter(x=>!ex.has(`${(x.date||'').slice(0,16)}|${x.amount}`));
      if(!nw.length){toast('æ— æ–°è®°å½•å¯æ¢å¤');return;}
      const n=await bulkInsert(nw);
      toast('å·²æ¢å¤ '+n+' æ¡è®°å½•');
    }catch{toast('æ–‡ä»¶æ ¼å¼é”™è¯¯');}
  };
  r.readAsText(f);e.target.value='';
}
async function clearAll(){
  if(!confirm('ç¡®å®šåˆ é™¤ä½ çš„æ‰€æœ‰è®°å½•ï¼Ÿ\nå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚'))return;
  const {error}=await sb.from('records').delete().eq('user_id',currentUser.id);
  if(error){toast('åˆ é™¤å¤±è´¥ï¼š'+error.message);return;}
  recs=[];render();toast('å·²æ¸…é™¤æ‰€æœ‰æ•°æ®');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SERVICE WORKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
boot();
</script>
</body>
</html>
